<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin â€“ Indoor/Outdoor EditÃ¶r (Manuel YayÄ±n + CanlÄ± Konum)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{position:fixed; inset:0; height:auto; width:auto; touch-action:none;}
  .panel{position:fixed; left:50%; bottom:10px; transform:translateX(-50%); z-index:10;
    background:#fff; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px; width:calc(100% - 20px); max-width:1080px;}
  .row{display:flex; flex-wrap:wrap; gap:8px}
  .row>*{flex:1 1 auto; min-width:120px}
  button,select,input[type="file"],input[type="text"]{
    padding:12px; border:1px solid #ddd; border-radius:10px; background:#fff; cursor:pointer
  }
  input[type="text"]{cursor:text}
  .primary{border-color:#b3d7ff; background:#f0f7ff}
  .active{outline:2px solid #3b82f6; background:#eaf2ff}
  #status{position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:11; background:#111; color:#fff; padding:6px 10px; border-radius:8px; display:none; font-size:13px}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:12}
  .panel2{background:#fff; width:min(560px,92vw); border-radius:14px; padding:14px; box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid label{font-size:12px; color:#555}
  .grid input,.grid textarea,.grid select{width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  textarea{min-height:72px}
  .actions{display:flex; gap:8px; justify-content:space-between; margin-top:10px}
  .actions .left{display:flex; gap:8px}
  .save{border-color:#b3d7ff; background:#f0f7ff; padding:10px 14px}
  .danger{border:1px solid #ffb3b3; background:#fff0f0; padding:10px 14px}
  .pill{padding:4px 8px; font-size:12px; border-radius:999px; background:#eef2ff; border:1px solid #c7d2fe}
  .small{font-size:12px; color:#555}
  @media (max-width: 640px){
    .panel{padding:8px}
    button,select,input[type="file"],input[type="text"]{padding:9px; font-size:14px}
    .row>*{min-width:100px}
  }
  .acc-badge{position:fixed; right:10px; top:10px; z-index:11; background:#fff; border:1px solid #ddd; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:0 4px 12px rgba(0,0,0,.15)}
</style>
</head>
<body>
<div id="map"></div>
<div id="status"></div>
<div id="acc" class="acc-badge" style="display:none"></div>

<div class="panel">
  <div class="row" style="margin-bottom:8px">
    <select id="layerSel">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
    </select>
    <input id="levelFilter" placeholder="Kat filtresi (Ã¶r: 1) â€“ boÅŸ=hepsi" />
    <button id="follow" class="primary" title="Harita konumumu izlesin">ðŸŽ¯ Takip: KapalÄ±</button>
    <button id="addPoint" class="primary">âž• Nokta</button>
    <button id="addPoly" class="primary">â¬› Poligon</button>
    <button id="finishDraw" style="display:none">âœ” Bitir</button>
    <button id="selectBtn">â˜‘ SeÃ§ / Ã–zellik</button>
    <span class="pill small">Aktif katman vurgulu</span>
  </div>
  <div class="row">
    <button id="expIndoor">â¤“ indoor.json</button>
    <button id="expOutdoor">â¤“ outdoor.json</button>
    <label style="display:flex;align-items:center;gap:6px">â¤’ JSON YÃ¼kle
      <input id="imp" type="file" accept=".json,application/json">
    </label>
    <button id="clearLocal" class="danger">ðŸ§¹ Yerel Veriyi Temizle</button>
  </div>
</div>

<!-- Ã–zellik Formu -->
<div id="propModal" class="modal" aria-hidden="true">
  <div class="panel2">
    <h3>Ã–zellikler</h3>
    <div class="grid">
      <div><label>Ä°sim</label><input id="f_name" placeholder="Ã–rn: Ana Restoran"></div>
      <div>
        <label>Kategori</label>
        <select id="f_category">
          <option value="">SeÃ§inizâ€¦</option>
          <option>restaurant</option><option>bar</option><option>spa</option><option>pool</option>
          <option>wc</option><option>elevator</option><option>stair</option><option>kidsclub</option>
          <option>reception</option><option>shop</option><option>gym</option><option>beach</option>
          <option>shuttle</option><option>parking</option><option>gate</option><option>info</option>
          <option value="_other">DiÄŸerâ€¦</option>
        </select>
      </div>
      <div style="grid-column:1/-1; display:none" id="catOtherWrap"><label>DiÄŸer Kategori</label><input id="f_category_other" placeholder="Ã¶r. lounge"></div>
      <div><label>Saatler</label><input id="f_hours" placeholder="09:00-22:00"></div>
      <div><label>Seviye/Kat</label><input id="f_level" placeholder="1"></div>
      <div style="grid-column:1/-1"><label>AÃ§Ä±klama</label><textarea id="f_desc" placeholder="KÄ±sa aÃ§Ä±klama"></textarea></div>
      <div style="grid-column:1/-1"><label>FotoÄŸraf URL</label><input id="f_image" placeholder="https://.../foto.jpg"></div>
      <div><label>Ã–ÄŸe ID (otomatik)</label><input id="f_id" disabled></div>
      <div><label>Alan/Uzunluk</label><input id="f_metric" disabled></div>
    </div>
    <div class="actions">
      <div class="left">
        <button id="propGeom" class="pill" title="Geometri noktalarÄ±nÄ± dÃ¼zenle">Geometriyi DÃ¼zenle</button>
        <button id="propDelete" class="danger">Sil</button>
      </div>
      <div>
        <button class="save" id="propSave">Kaydet</button>
        <button class="save" id="propClose">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== yardÄ±mcÄ±lar ====== */
const $ = id => document.getElementById(id);
const statusEl = $("status");
const setStatus = (msg, ms=2200)=>{ if(!msg){statusEl.style.display="none";return;} statusEl.textContent=msg; statusEl.style.display="block"; if(ms>0) setTimeout(()=>statusEl.style.display="none", ms); };
const fmt = new ol.format.GeoJSON();
function isFC(gj){ return gj && gj.type==="FeatureCollection" && Array.isArray(gj.features); }
const writeGJ = layer => JSON.parse(fmt.writeFeatures(layer.getSource().getFeatures(),{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}));
const readGJToLayer = (layer, gj) => { if(!isFC(gj)) throw new Error("FeatureCollection bekleniyor"); const fs=fmt.readFeatures(gj,{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}); layer.getSource().clear(); layer.getSource().addFeatures(fs); };
function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
const saveLocalRaw = (k,d)=>{ try{ localStorage.setItem(k, JSON.stringify(d)); }catch(e){ alert("Yerel depolama dolu olabilir."); } };
const saveLocal = debounce((k,layer)=> saveLocalRaw(k, writeGJ(layer)), 250);
const loadLocal = k => { const s=localStorage.getItem(k); try{return s?JSON.parse(s):null;}catch{return null;} };

/* ====== katmanlar ====== */
function baseStyleFor(f, dim=1){
  const t=f.getGeometry().getType();
  const stroke=new ol.style.Stroke({color:`rgba(0,0,0,${0.6*dim})`,width:2});
  const fill=new ol.style.Fill({color:`rgba(0,150,0,${0.18*dim})`});
  const circle=new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:`rgba(200,0,0,${1*dim})`}),stroke:new ol.style.Stroke({color:"#fff",width:1})});
  return t==="Point" ? new ol.style.Style({image:circle}) : new ol.style.Style({stroke,fill});
}
function styleWrapper(name){
  return f=>{
    const active=$("layerSel").value;
    const filter=$("levelFilter").value.trim();
    const lvl=(f.get("level")??"").toString().trim();
    const isActive=active===name;
    if(filter && lvl!==filter) return null;
    return baseStyleFor(f, isActive?1:0.35);
  };
}
const indoorLayer  = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("indoor")});
const outdoorLayer = new ol.layer.VectorImage({source:new ol.source.Vector(), style:styleWrapper("outdoor")});
const map = new ol.Map({ target:"map", layers:[ new ol.layer.Tile({source:new ol.source.OSM()}), indoorLayer, outdoorLayer ], view:new ol.View({center: ol.proj.fromLonLat([31.805,36.600]), zoom:17}) });
const tgtLayer = ()=> $("layerSel").value==="indoor" ? indoorLayer : outdoorLayer;

/* ====== veri yÃ¼kleme ====== */
let bulk=false;
(function initLoad(){
  bulk=true;
  readGJToLayer(indoorLayer,  loadLocal("indoor")  || {"type":"FeatureCollection","features":[]});
  readGJToLayer(outdoorLayer, loadLocal("outdoor") || {"type":"FeatureCollection","features":[]});
  bulk=false;
})();

/* ====== konum â€“ canlÄ± mavi nokta + takip ====== */
const accEl = $("acc");
let userMarker=null, accCircle=null, userLayer=null, follow=false, watchId=null;

function ensureHttpsOrLocalhost(){
  const prot = location.protocol;
  const host = location.hostname;
  if(!(prot==="https:" || host==="localhost" || host==="127.0.0.1")){
    setStatus("Konum iÃ§in HTTPS gerekir. (GitHub Pages â€˜httpsâ€™ tamam.)", 4000);
  }
}
ensureHttpsOrLocalhost();

function startWatch(){
  if(!("geolocation" in navigator)) { setStatus("Cihazda konum desteÄŸi yok."); return; }
  try{
    if(watchId!==null) navigator.geolocation.clearWatch(watchId);
  }catch{}
  watchId = navigator.geolocation.watchPosition(onPos, onGeoError, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
  // izin durumu bilgilendirmesi
  if(navigator.permissions?.query){
    navigator.permissions.query({name:"geolocation"}).then(p=>{
      if(p.state==="denied") setStatus("Konum izni reddedildi. TarayÄ±cÄ± ayarlarÄ±ndan 'Precise/DoÄŸru Konum'u aÃ§Ä±n.", 5000);
    }).catch(()=>{});
  }
}
function onGeoError(err){ setStatus("Konum alÄ±namadÄ±: " + (err?.message||err?.code||"bilinmiyor"), 4000); }
function onPos(pos){
  const lon=pos.coords.longitude, lat=pos.coords.latitude, acc=pos.coords.accuracy||0;
  const coords = ol.proj.fromLonLat([lon,lat]);
  if(!userMarker){
    userMarker = new ol.Feature(new ol.geom.Point(coords));
    userMarker.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:"#007bff"}), stroke:new ol.style.Stroke({color:"#fff",width:2})}) }));
    accCircle  = new ol.Feature(new ol.geom.Circle(coords, acc));
    accCircle.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({color:"#007bff",width:1}), fill:new ol.style.Fill({color:"rgba(0,123,255,0.08)"}) }));
    userLayer  = new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userMarker]}) });
    map.addLayer(userLayer);
  }else{
    userMarker.getGeometry().setCoordinates(coords);
    accCircle.getGeometry().setCenter(coords);
    accCircle.getGeometry().setRadius(acc);
  }
  accEl.textContent = "Â±" + Math.round(acc) + " m";
  accEl.style.display = "block";
  if(follow) map.getView().animate({center: coords, duration: 200});
}
startWatch();

/* ====== etkileÅŸimler ====== */
let mode=null, draw=null, select=null, selected=null, modify=null, snap=null;
function resetInteractions(){ if(draw){map.removeInteraction(draw);draw=null;} if(select){map.removeInteraction(select);select=null;} if(modify){map.removeInteraction(modify);modify=null;} if(snap){map.removeInteraction(snap);snap=null;} selected=null; mode=null; ["addPoint","addPoly","selectBtn"].forEach(id=>$(id).classList.remove("active")); $("finishDraw").style.display="none"; map.getTargetElement().style.cursor=""; }
function enableSnap(layer){ if(snap) map.removeInteraction(snap); snap=new ol.interaction.Snap({source:layer.getSource()}); map.addInteraction(snap); }
function enrich(f){ try{ if(!f.getId() && crypto?.randomUUID) f.setId(crypto.randomUUID()); }catch{} const g=f.getGeometry(); if(g.getType()==="Polygon") f.set("area_m2",Math.round(g.getArea())); }

$("follow").onclick=()=>{
  follow=!follow; $("follow").textContent = follow ? "ðŸŽ¯ Takip: AÃ§Ä±k" : "ðŸŽ¯ Takip: KapalÄ±";
  if(follow && userMarker){ map.getView().setCenter(userMarker.getGeometry().getCoordinates()); }
};

map.on("singleclick",(evt)=>{ if(mode!=="point") return; const f=new ol.Feature(new ol.geom.Point(evt.coordinate)); enrich(f); tgtLayer().getSource().addFeature(f); openForm(f); saveLocal($("layerSel").value, tgtLayer()); });

$("addPoint").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="point"; $("addPoint").classList.add("active"); setStatus("NOKTA: haritaya tÄ±kla/dokun"); map.getTargetElement().style.cursor="crosshair"; };

$("addPoly").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="polygon"; $("addPoly").classList.add("active"); setStatus("POLÄ°GON: noktalarÄ± yerleÅŸtir; bitirmek iÃ§in Ã§ift tÄ±k ya da âœ” Bitir"); map.getTargetElement().style.cursor="crosshair"; const layer=tgtLayer(); draw=new ol.interaction.Draw({source:layer.getSource(),type:"Polygon"}); map.addInteraction(draw); enableSnap(layer); $("finishDraw").style.display="inline-block"; $("finishDraw").onclick=()=>{ if(draw) draw.finishDrawing(); }; draw.once("drawend",(ev)=>{ $("finishDraw").style.display="none"; enrich(ev.feature); openForm(ev.feature); saveLocal($("layerSel").value, layer); }); };

$("selectBtn").onclick=(e)=>{ e.preventDefault(); resetInteractions(); mode="select"; $("selectBtn").classList.add("active"); setStatus("SEÃ‡Ä°M: Ã¶ÄŸeye tÄ±kla â†’ form aÃ§Ä±lÄ±r"); const layer=tgtLayer(); select=new ol.interaction.Select({layers:[layer]}); if(select.setHitTolerance) select.setHitTolerance(6); map.addInteraction(select); select.on("select",ev=>{ selected=ev.selected[0]||null; if(selected) openForm(selected); }); };

$("layerSel").addEventListener("change",()=>{ resetInteractions(); indoorLayer.changed(); outdoorLayer.changed(); });
$("levelFilter").addEventListener("input",()=>{ indoorLayer.changed(); outdoorLayer.changed(); });

/* ====== Ã–zellik Formu ====== */
const modal=$("propModal");
function validateImg(u){ try{ const x=new URL(u); if(!(x.protocol==="http:"||x.protocol==="https:")) return false; return /\.(jpg|jpeg|png|gif|webp|avif|svg)(\?.*)?$/i.test(x.pathname); }catch{return false;} }
function openForm(f){
  const p=f.getProperties(); const catSel=$("f_category"), otherWrap=$("catOtherWrap"), other=$("f_category_other");
  $("f_name").value=p.name||""; $("f_hours").value=p.hours||""; $("f_level").value=p.level||""; $("f_desc").value=p.desc||""; $("f_image").value=p.image||""; $("f_id").value=f.getId()||""; $("f_metric").value=p.area_m2? (p.area_m2+" mÂ²"): (p.len_m? (p.len_m+" m"):"");
  if(p.category && [...catSel.options].some(o=>o.value===p.category)){ catSel.value=p.category; otherWrap.style.display="none"; other.value=""; }
  else if(p.category){ catSel.value="_other"; otherWrap.style.display="block"; other.value=p.category; }
  else { catSel.value=""; otherWrap.style.display="none"; other.value=""; }
  catSel.onchange=()=>{ if(catSel.value==="_other") otherWrap.style.display="block"; else {otherWrap.style.display="none"; other.value="";} };
  modal.style.display="flex"; modal.setAttribute("aria-hidden","false");
  $("propSave").onclick=()=>{ const img=$("f_image").value.trim(); if(img && !validateImg(img)){ alert("FotoÄŸraf URL geÃ§ersiz."); return; } f.setProperties({ name:$("f_name").value.trim(), category:(catSel.value==="_other"? other.value.trim(): catSel.value.trim()), hours:$("f_hours").value.trim(), level:$("f_level").value.trim(), desc:$("f_desc").value.trim(), image:img }); enrich(f); saveLocal($("layerSel").value, tgtLayer()); };
  $("propClose").onclick=()=>{ modal.style.display="none"; modal.setAttribute("aria-hidden","true"); resetInteractions(); };
  $("propGeom").onclick=()=>{ // sadece bu feature Ã¼zerinde geÃ§ici modify
    if(modify) map.removeInteraction(modify);
    modify=new ol.interaction.Modify({ features: new ol.Collection([f]) });
    map.addInteraction(modify);
    enableSnap(tgtLayer());
    modify.on("modifyend",()=>{ enrich(f); saveLocal($("layerSel").value, tgtLayer()); });
  };
  $("propDelete").onclick=()=>{ if(confirm("Bu Ã¶ÄŸe silinsin mi?")){ tgtLayer().getSource().removeFeature(f); saveLocal($("layerSel").value, tgtLayer()); modal.style.display="none"; resetInteractions(); } };
}
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modal.style.display==="flex"){ modal.style.display="none"; resetInteractions(); } });

/* ====== indir / yÃ¼kle / temizle ====== */
function dl(obj,name){ const b=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"}); const u=URL.createObjectURL(b); const a=document.createElement("a"); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
$("expIndoor").onclick=()=> dl(writeGJ(indoorLayer),"indoor.json");
$("expOutdoor").onclick=()=> dl(writeGJ(outdoorLayer),"outdoor.json");
$("imp").addEventListener("change", async e=>{
  const file=e.target.files[0]; if(!file) return;
  if(file.size>5*1024*1024){ alert("Dosya > 5MB."); e.target.value=""; return; }
  try{ const json=JSON.parse(await file.text()); const layer=tgtLayer(); readGJToLayer(layer,json); saveLocal($("layerSel").value, layer); alert("GeoJSON yÃ¼klendi."); }catch{ alert("GeÃ§ersiz GeoJSON."); }
  e.target.value="";
});
$("clearLocal").onclick=()=>{ if(confirm("Yerel veriyi sil?")){ localStorage.removeItem("indoor"); localStorage.removeItem("outdoor"); alert("Temizlendi. SayfayÄ± yenileyin."); } };

setStatus("HazÄ±r: CanlÄ± konum + takip + sade admin.");
</script>
</body>
</html>
