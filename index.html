<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Misafir – Indoor & Outdoor Harita</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --pad:10px;
      --radius:12px;
      --shadow:0 6px 20px rgba(0,0,0,.12);
    }
    html,body{height:100%;margin:0}
    body{font:14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    #map{position:fixed; inset:0;}

    /* Üst araç çubuğu */
    .toolbar{
      position:fixed; left:12px; right:12px; top:12px; z-index:1000;
      background:#fff; border-radius:var(--radius); padding:10px;
      box-shadow:var(--shadow);
    }
    .row{
      display:flex; align-items:center; gap:8px;
      overflow-x:auto; /* çok dar ekranda taşanı kaydır */
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .row::-webkit-scrollbar{display:none}
    .row > *{flex:0 0 auto}

    input[type="search"]{
      min-width:180px; width:50vw; max-width:520px;
      padding:8px 10px; border:1px solid #ddd; border-radius:10px;
    }
    button,.btn{
      padding:8px 10px; border:1px solid #ddd; background:#f7f7f7;
      border-radius:10px; cursor:pointer;
    }
    button:active{transform:translateY(1px)}
    select{
      padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff;
    }

    /* Popup içi küçük rozeti */
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}

    /* Telefonlarda rahat görünsün */
    @media (max-width:480px){
      input[type="search"]{width:56vw; min-width:160px}
    }

    /* Leaflet attribution biraz yukarı */
    .leaflet-control-attribution{background:rgba(255,255,255,.85); border-radius:8px}
  </style>
</head>
<body>

  <!-- Üst araç çubuğu -->
  <div class="toolbar" role="toolbar" aria-label="Üst araç çubuğu">
    <div class="row">
      <input id="q" type="search" placeholder="Ara: restoran, spa, havuz…" />
      <button id="go">Git</button>

      <select id="preset">
        <option value="">Hedef Seç</option>
      </select>

      <select id="lang" aria-label="Dil">
        <option value="tr" selected>Türkçe</option>
        <option value="en">English</option>
        <option value="ru">Русский</option>
        <option value="de">Deutsch</option>
        <option value="pl">Polski</option>
      </select>
    </div>
  </div>

  <div id="map" aria-label="Harita"></div>

<script>
/* =========================
   Basit i18n (TR, EN, RU, DE, PL)
   ========================= */
const I18N = {
  tr:{
    searchPH:"Ara: restoran, spa, havuz…",
    go:"Git", choose:"Hedef Seç",
    labels:{name:"İsim", category:"Tür", hours:"Saat", level:"Kat", desc:"Açıklama"},
    cats:{ pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"Dükkan", toilet:"WC" }
  },
  en:{
    searchPH:"Search: restaurant, spa, pool…",
    go:"Go", choose:"Pick a place",
    labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description"},
    cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet" }
  },
  ru:{
    searchPH:"Поиск: ресторан, спа, бассейн…",
    go:"Поехали", choose:"Выбрать место",
    labels:{name:"Название", category:"Тип", hours:"Часы", level:"Этаж", desc:"Описание"},
    cats:{ pool:"Бассейн", restaurant:"Ресторан", spa:"Спа", bar:"Бар", cafe:"Кафе", shop:"Магазин", toilet:"Туалет" }
  },
  de:{
    searchPH:"Suche: Restaurant, Spa, Pool…",
    go:"Los", choose:"Ziel wählen",
    labels:{name:"Name", category:"Art", hours:"Zeiten", level:"Etage", desc:"Beschreibung"},
    cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Café", shop:"Laden", toilet:"WC" }
  },
  pl:{
    searchPH:"Szukaj: restauracja, spa, basen…",
    go:"Idź", choose:"Wybierz cel",
    labels:{name:"Nazwa", category:"Typ", hours:"Godziny", level:"Poziom", desc:"Opis"},
    cats:{ pool:"Basen", restaurant:"Restauracja", spa:"Spa", bar:"Bar", cafe:"Kawiarnia", shop:"Sklep", toilet:"Toaleta" }
  }
};
let LANG = localStorage.getItem("lang") || "tr";

/* =========================
   Harita kurulumu (Leaflet)
   ========================= */
const map = L.map('map', {
  zoomControl: true,
  worldCopyJump: true
}).setView([36.6002,31.8046], 16);

/* OSM zemin katmanı */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20,
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> katılımcıları'
}).addTo(map);

/* Dış mekan verisi */
let featureLayer = null;
let featuresIndex = {};   // id -> layer
let featuresData = [];    // orijinal geojson features

/* UI elemanları */
const $q = document.getElementById('q');
const $go = document.getElementById('go');
const $preset = document.getElementById('preset');
const $lang = document.getElementById('lang');

/* Dil uygula */
function applyLang(){
  const t = I18N[LANG] || I18N.tr;
  $q.placeholder = t.searchPH;
  $go.textContent = t.go;

  // Hedef select'in ilk satırı
  $preset.options[0].textContent = t.choose;

  // Açık popup varsa içeriği güncelle
  featureLayer && featureLayer.eachLayer(l => {
    if(l.isPopupOpen()){
      l.setPopupContent(renderPopup(l.feature));
    }
  });

  // kaydet
  localStorage.setItem("lang", LANG);
}
$lang.value = LANG;
$lang.addEventListener('change', () => { LANG = $lang.value; applyLang(); });

/* Popup içeriği (çok dillilik) */
function renderPopup(feat){
  const p = feat.properties || {};
  const t = I18N[LANG] || I18N.tr;

  const name = p['name_'+LANG] || p.name || '';
  const catKey = (p.category || '').toLowerCase();
  const catLabel = t.cats[catKey] || p.category || '';

  const hours = p['hours_'+LANG] || p.hours || '';
  const level = p['level_'+LANG] || p.level || '';
  const desc  = p['desc_'+LANG]  || p.desc  || '';

  return `
    <div style="min-width:180px">
      <div style="font-weight:600; margin-bottom:6px">${name}</div>
      ${catLabel ? `<div class="badge" title="${t.labels.category}">${catLabel}</div>`:''}
      ${hours ? `<div style="margin-top:6px"><small>${t.labels.hours}:</small> ${hours}</div>`:''}
      ${level ? `<div><small>${t.labels.level}:</small> ${level}</div>`:''}
      ${desc  ? `<div style="margin-top:6px">${desc}</div>`:''}
    </div>
  `;
}

/* GeoJSON yükle ve haritaya ekle */
fetch('outdoor.json')
  .then(r => r.json())
  .then(geojson => {
    featuresData = geojson.features || [];

    featureLayer = L.geoJSON(geojson, {
      pointToLayer: (feat, latlng) =>
        L.circleMarker(latlng, {
          radius: 7, weight: 2, color:'#c1121f', fillColor:'#f94144', fillOpacity:.9
        }),
      onEachFeature: (feat, layer) => {
        featuresIndex[feat.id || L.Util.stamp(layer)] = layer;
        layer.bindPopup(renderPopup(feat));
      }
    }).addTo(map);

    // Eğer veri alanı varsa ona göre odakla
    try{
      const b = featureLayer.getBounds();
      if (b.isValid()) map.fitBounds(b.pad(0.2));
    }catch(e){/* tek nokta olabilir, sorun değil */}

    // Hedef listesine doldur
    rebuildPresetOptions();
    applyLang();
  })
  .catch(err => {
    console.error('outdoor.json yükleme hatası', err);
    applyLang();
  });

function rebuildPresetOptions(){
  // ilk option'u koru, geri kalanını temizle
  for(let i=$preset.options.length-1;i>=1;i--){ $preset.remove(i); }

  // Sırala: ada göre
  const arr = [...featuresData];
  arr.sort((a,b)=>{
    const na = (a.properties['name_'+LANG] || a.properties.name || '').toLocaleLowerCase(LANG);
    const nb = (b.properties['name_'+LANG] || b.properties.name || '').toLocaleLowerCase(LANG);
    return na.localeCompare(nb);
  });

  arr.forEach(f=>{
    const name = f.properties['name_'+LANG] || f.properties.name || f.id;
    const opt = document.createElement('option');
    opt.value = f.id || '';
    opt.textContent = name;
    $preset.appendChild(opt);
  });
}

/* Preset seçilince git ve popup aç */
