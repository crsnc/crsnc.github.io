<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenLayers – Indoor & Outdoor</title>

<!-- OpenLayers CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>

<style>
  html, body {margin:0; padding:0; height:100%;}
  #map {width:100%; height:100%;}

  /* Toolbar */
  .toolbar {
    position:absolute; top:10px; left:10px; z-index:1000;
    background:#fff; padding:6px; border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; gap:6px;
  }
  .toolbar input {padding:6px; width:220px;}
  .toolbar select, .toolbar button {padding:6px;}

  /* Search sonuç kutusu */
  .results {
    position:absolute; top:50px; left:10px; z-index:1001;
    background:#fff; border:1px solid #ccc; border-radius:6px;
    width:220px; max-height:40vh; overflow:auto; display:none;
  }
  .results .item {padding:6px; cursor:pointer;}
  .results .item:hover {background:#f0f0f0;}
</style>
</head>
<body>
<div id="map"></div>

<!-- Toolbar -->
<div class="toolbar">
  <input id="searchInput" type="text" placeholder="Ara: disco, havuz, restoran, spa…" />
  <select id="lang"><option value="tr">TR</option><option value="en">EN</option><option value="ru">RU</option></select>
  <button id="goBtn" disabled>Git</button>
  <button id="pickBtn">Hedef Seç</button>
</div>
<div id="results" class="results"></div>

<script>
/* ------------------ 1) Hotel Polygon ------------------ */
const HOTEL_GEOMETRY = {
  "type":"Polygon",
  "coordinates":[[ 
    [31.80488563536983,36.60144809135009],
    [31.80141125277774,36.599560719072684],
    [31.806994242514662,36.59688713533359],
    [31.80828178115803,36.59899633325935],
    [31.80488563536983,36.60144809135009]
  ]]
};

/* ------------------ 2) Indoor & Outdoor DEMO ------------------ */
const DEMO_INDOOR = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"id":"lobi","name":"Lobi","category":"lobby","level":1},
     "geometry":{"type":"Polygon","coordinates":[[
       [31.8050,36.6005],[31.8052,36.6005],[31.8052,36.6007],[31.8050,36.6007],[31.8050,36.6005]
     ]]}},
    {"type":"Feature","properties":{"id":"resto","name":"Ana Restoran","category":"restaurant","level":1},
     "geometry":{"type":"Polygon","coordinates":[[
       [31.8053,36.6006],[31.8056,36.6006],[31.8056,36.6009],[31.8053,36.6009],[31.8053,36.6006]
     ]]} }
  ]
};
const DEMO_OUTDOOR = {
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"id":"disco","name":"Disco","category":"disco"},
     "geometry":{"type":"Point","coordinates":[31.8053,36.6002]}},
    {"type":"Feature","properties":{"id":"pool","name":"Ana Havuz","category":"pool"},
     "geometry":{"type":"Point","coordinates":[31.8055,36.6004]}}
  ]
};

/* ------------------ 3) Vector Layers ------------------ */
function makeVectorLayer(geojson, color){
  return new ol.layer.Vector({
    source: new ol.source.Vector({
      features: new ol.format.GeoJSON().readFeatures(geojson,{featureProjection:"EPSG:3857"})
    }),
    style: new ol.style.Style({
      stroke: new ol.style.Stroke({color:color,width:2}),
      fill: new ol.style.Fill({color:color.replace('1)', '0.3)')}),
      image: new ol.style.Circle({radius:6, fill: new ol.style.Fill({color:color})})
    })
  });
}

const hotelLayer = makeVectorLayer(
  {"type":"FeatureCollection","features":[{"type":"Feature","geometry":HOTEL_GEOMETRY}]},
  "rgba(0,0,255,1)"
);
const indoorLayer = makeVectorLayer(DEMO_INDOOR, "rgba(0,200,0,1)");
const outdoorLayer = makeVectorLayer(DEMO_OUTDOOR, "rgba(200,0,0,1)");

/* ------------------ 4) Map ------------------ */
const map = new ol.Map({
  target: "map",
  layers: [new ol.layer.Tile({source: new ol.source.OSM()}), hotelLayer, indoorLayer, outdoorLayer],
  view: new ol.View({
    center: ol.proj.fromLonLat([31.805,36.600]),
    zoom: 17,
    rotation: 0
  })
});

/* ------------------ 5) Search + Autocomplete ------------------ */
const searchInput = document.getElementById("searchInput");
const resultsEl = document.getElementById("results");
let selectedFeature = null;

// tüm indoor & outdoor özelliklerini arama için indexle
const allFeatures = indoorLayer.getSource().getFeatures().concat(outdoorLayer.getSource().getFeatures());

function showResults(list){
  resultsEl.innerHTML="";
  if(!list.length){resultsEl.style.display="none";return;}
  list.forEach(f=>{
    const div=document.createElement("div");
    div.className="item";
    div.textContent=f.get("name")+" ("+(f.get("category")||"")+")";
    div.onclick=()=>{
      selectedFeature=f;
      const extent=f.getGeometry().getExtent();
      map.getView().fit(extent,{maxZoom:19});
      resultsEl.style.display="none";
      document.getElementById("goBtn").disabled=false;
    };
    resultsEl.appendChild(div);
  });
  resultsEl.style.display="block";
}

searchInput.addEventListener("input", ()=>{
  const val=searchInput.value.toLowerCase().trim();
  if(!val){resultsEl.style.display="none";return;}
  const matches=allFeatures.filter(f=>(f.get("name")||"").toLowerCase().includes(val));
  showResults(matches);
});

/* ------------------ 6) Routing (OSRM demo) ------------------ */
const goBtn=document.getElementById("goBtn");
goBtn.addEventListener("click", ()=>{
  if(!selectedFeature) return alert("Bir hedef seçin!");
  navigator.geolocation.getCurrentPosition(pos=>{
    const user=[pos.coords.longitude,pos.coords.latitude];
    const target=ol.proj.toLonLat(selectedFeature.getGeometry().getFirstCoordinate());
    // OSRM api ile rota
    const url=`https://router.project-osrm.org/route/v1/foot/${user[0]},${user[1]};${target[0]},${target[1]}?overview=full&geometries=geojson`;
    fetch(url).then(r=>r.json()).then(data=>{
      if(data.routes.length){
        const coords=data.routes[0].geometry.coordinates;
        const line=new ol.geom.LineString(coords).transform("EPSG:4326","EPSG:3857");
        const route=new ol.Feature({geometry:line});
        const routeLayer=new ol.layer.Vector({
          source:new ol.source.Vector({features:[route]}),
          style:new ol.style.Style({stroke:new ol.style.Stroke({color:"blue",width:3})})
        });
        map.addLayer(routeLayer);
      }
    });
  },()=>alert("Konum alınamadı"));
});

/* ------------------ 7) Rotate ------------------ */
// Mobilde 2 parmak → rotate
// Desktop: ALT + Drag
</script>
</body>
</html>
