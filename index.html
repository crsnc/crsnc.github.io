<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Admin ‚Äì Indoor/Outdoor Veri Edit√∂r√º</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{height:100%}
  .panel{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);z-index:10;
    background:#fff;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);
    padding:10px;width:calc(100% - 20px);max-width:980px}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  .row>*{flex:1 1 auto;min-width:120px}
  button,select,input[type="file"]{padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff}
  .primary{border-color:#b3d7ff;background:#f0f7ff}
  .danger{border-color:#ffb3b3;background:#fff0f0}
  #toast{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:20;background:#111;color:#fff;
    padding:8px 12px;border-radius:8px;display:none}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:20}
  .panel2{background:#fff;width:min(520px,92vw);border-radius:14px;padding:14px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid label{font-size:12px;color:#555}
  .grid input,.grid textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
  textarea{min-height:72px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .actions button{padding:10px 14px;border:1px solid #ddd;border-radius:8px;background:#fff}
  .save{border-color:#b3d7ff;background:#f0f7ff}
  .cancel{background:#fafafa}
</style>
</head>
<body>
<div id="map"></div>

<div id="toast"></div>

<div class="panel">
  <div class="row" style="margin-bottom:8px">
    <select id="layerSel">
      <option value="outdoor">Hedef: OUTDOOR</option>
      <option value="indoor">Hedef: INDOOR</option>
    </select>
    <button id="myPos" class="primary">üìç Benim Konumum</button>
    <button id="addPoint" class="primary">‚ûï Nokta</button>
    <button id="addPoly" class="primary">‚¨õ Poligon</button>
    <button id="modify">‚úé D√ºzenle</button>
    <button id="selectBtn">‚òë Se√ß / √ñzellik</button>
    <button id="del" class="danger">üóë Sil</button>
  </div>
  <div class="row">
    <button id="expIndoor">‚§ì indoor.json</button>
    <button id="expOutdoor">‚§ì outdoor.json</button>
    <label style="display:flex;align-items:center;gap:6px">‚§í JSON Y√ºkle
      <input id="imp" type="file" accept=".json,application/json">
    </label>
    <button id="clearLocal" class="danger">üßπ Yerel Veriyi Temizle</button>
  </div>
</div>

<!-- √ñzellik Formu -->
<div id="propModal" class="modal">
  <div class="panel2">
    <h3>√ñzellikler</h3>
    <div class="grid">
      <div>
        <label>ƒ∞sim</label>
        <input id="f_name" placeholder="√ñrn: Ana Restoran">
      </div>
      <div>
        <label>Kategori</label>
        <input id="f_category" placeholder="restaurant, spa, bar">
      </div>
      <div>
        <label>Saatler</label>
        <input id="f_hours" placeholder="09:00-22:00">
      </div>
      <div>
        <label>Seviye/Kat</label>
        <input id="f_level" placeholder="1">
      </div>
      <div style="grid-column:1/-1">
        <label>A√ßƒ±klama</label>
        <textarea id="f_desc" placeholder="Kƒ±sa a√ßƒ±klama"></textarea>
      </div>
      <div style="grid-column:1/-1">
        <label>Fotoƒüraf URL</label>
        <input id="f_image" placeholder="https://.../foto.jpg">
      </div>
    </div>
    <div class="actions">
      <button class="cancel" id="propCancel">Vazge√ß</button>
      <button class="save" id="propSave">Kaydet</button>
    </div>
  </div>
</div>

<script>
/* ===================== Yardƒ±mcƒ±lar ===================== */
const $ = s => document.querySelector(s);
const fmt = new ol.format.GeoJSON();
const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; setTimeout(()=>el.style.display="none",1800); };

// G√ºvenli √ßift tƒ±k/√ßift dokunu≈ü bitirme
const safeDoubleClick = (e) => e && e.originalEvent && e.originalEvent.type === 'dblclick';

// DoubleClickZoom'u ge√ßici devre dƒ±≈üƒ± bƒ±rak/a√ß
function withDoubleClickZoomDisabled(map, fn){
  const dcZoom = map.getInteractions().getArray().find(i => i instanceof ol.interaction.DoubleClickZoom);
  const prev = dcZoom ? dcZoom.getActive() : null;
  if (dcZoom) dcZoom.setActive(false);
  try { fn(); } finally { if (dcZoom && prev !== null) dcZoom.setActive(prev); }
}

// JSON ara√ßlarƒ±
function gjFromLayer(layer){
  return JSON.parse(fmt.writeFeatures(layer.getSource().getFeatures(),{featureProjection:"EPSG:3857",dataProjection:"EPSG:4326"}));
}
function loadGJ(layer, gj){
  const fs = fmt.readFeatures(gj,{featureProjection:"EPSG:3857"});
  layer.getSource().clear(); layer.getSource().addFeatures(fs);
}
function dl(obj, name){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
}
function saveLocal(key, layer){ localStorage.setItem(key, JSON.stringify(gjFromLayer(layer))); }
function loadLocal(key){ const s=localStorage.getItem(key); return s?JSON.parse(s):null; }

/* ===================== Harita & Katmanlar ===================== */
function styleFor(f){
  const t=f.getGeometry().getType();
  const stroke=new ol.style.Stroke({color:"rgba(0,0,0,0.6)",width:2});
  const fill=new ol.style.Fill({color:"rgba(0,150,0,0.18)"});
  const circle=new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"rgba(200,0,0,1)"}),stroke:new ol.style.Stroke({color:"#fff",width:1})});
  return t==="Point" ? new ol.style.Style({image:circle}) : new ol.style.Style({stroke,fill});
}
const indoorLayer  = new ol.layer.Vector({source:new ol.source.Vector(), style:styleFor});
const outdoorLayer = new ol.layer.Vector({source:new ol.source.Vector(), style:styleFor});

const map = new ol.Map({
  target:"map",
  layers:[ new ol.layer.Tile({source:new ol.source.OSM()}), indoorLayer, outdoorLayer ],
  view:new ol.View({center: ol.proj.fromLonLat([31.805,36.600]), zoom:17})
});

/* ===================== Veri y√ºkleme sƒ±rasƒ± =====================
   1) localStorage  2) indoor.json/outdoor.json  3) bo≈ü    */
async function tryFetch(url){
  try{const r=await fetch(url,{cache:"no-cache"}); if(!r.ok) throw 0; return await r.json();}catch(e){return null;}
}
(async ()=>{
  loadGJ(indoorLayer,  loadLocal("indoor")  || (await tryFetch("indoor.json"))  || {"type":"FeatureCollection","features":[]});
  loadGJ(outdoorLayer, loadLocal("outdoor") || (await tryFetch("outdoor.json")) || {"type":"FeatureCollection","features":[]});
})();

/* ===================== Konum (isteƒüe baƒülƒ±) ===================== */
let lastPos=null;
navigator.geolocation.watchPosition(p=>{ lastPos=p; },{enableHighAccuracy:true,maximumAge:0,timeout:10000});

/* ===================== Hedef katman se√ßici ===================== */
function tgt(){ return $("#layerSel").value==="indoor" ? indoorLayer : outdoorLayer; }

/* ===================== Etkile≈üimler ===================== */
let draw=null, modify=null, select=null, snap=null, selected=null;
function clearInteractions(){
  [draw, modify, select, snap].forEach(i=>{ if(i) map.removeInteraction(i); });
  draw=modify=select=snap=null; selected=null;
}

/* ‚ûï Nokta */
$("#addPoint").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  clearInteractions();
  const layer = tgt();

  draw = new ol.interaction.Draw({ source: layer.getSource(), type: "Point" });
  map.addInteraction(draw);
  snap = new ol.interaction.Snap({ source: layer.getSource() });
  map.addInteraction(snap);

  draw.once("drawend", (e)=>{
    openForm(e.feature);
    saveLocal($("#layerSel").value, layer);
    toast("Nokta eklendi");
    clearInteractions();
  });
});

/* ‚¨õ Poligon */
$("#addPoly").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  clearInteractions();
  const layer = tgt();

  withDoubleClickZoomDisabled(map, ()=>{
    draw = new ol.interaction.Draw({
      source: layer.getSource(),
      type: "Polygon",
      finishCondition: safeDoubleClick
    });
    map.addInteraction(draw);
  });

  snap = new ol.interaction.Snap({ source: layer.getSource() });
  map.addInteraction(snap);

  toast("Poligon: noktalarƒ± dokunarak yerle≈ütir, bitirmek i√ßin √ßift dokun/√ßift tƒ±kla");
  draw.once("drawend", (e)=>{
    openForm(e.feature);
    saveLocal($("#layerSel").value, layer);
    clearInteractions();
  });
});

/* ‚úé D√ºzenle */
$("#modify").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  clearInteractions();
  const layer = tgt();
  modify = new ol.interaction.Modify({ source: layer.getSource() });
  map.addInteraction(modify);
  snap = new ol.interaction.Snap({ source: layer.getSource() }); map.addInteraction(snap);
  modify.on("modifyend", ()=>{ saveLocal($("#layerSel").value, layer); toast("Geometri g√ºncellendi"); });
});

/* ‚òë Se√ß / √ñzellik */
$("#selectBtn").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  clearInteractions();
  const layer = tgt();
  select = new ol.interaction.Select({ layers:[layer] });
  if (select.setHitTolerance) select.setHitTolerance(5); // mobilde daha rahat se√ßim
  map.addInteraction(select);
  select.on("select", (e)=>{
    selected = e.selected[0] || null;
    if (selected) openForm(selected);
  });
});

/* üóë Sil */
$("#del").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  const layer = tgt();
  if(!selected){ alert("Silmek i√ßin √∂nce 'Se√ß / √ñzellik' ile bir √∂ƒüe se√ß."); return; }
  layer.getSource().removeFeature(selected); selected=null;
  saveLocal($("#layerSel").value, layer); toast("Silindi");
});

/* üìç Benim Konumum */
$("#myPos").addEventListener("click", (ev)=>{
  ev.preventDefault(); ev.stopPropagation();
  const layer = tgt();
  if(!lastPos){ alert("Konum alƒ±namadƒ±."); return; }
  const c = ol.proj.fromLonLat([lastPos.coords.longitude, lastPos.coords.latitude]);
  const f = new ol.Feature(new ol.geom.Point(c));
  layer.getSource().addFeature(f);
  openForm(f);
  saveLocal($("#layerSel").value, layer);
});

/* ===================== √ñzellik formu ===================== */
function openForm(feat){
  const p=feat.getProperties();
  $("#f_name").value=p.name||"";
  $("#f_category").value=p.category||"";
  $("#f_hours").value=p.hours||"";
  $("#f_level").value=p.level||"";
  $("#f_desc").value=p.desc||"";
  $("#f_image").value=p.image||"";
  $("#propModal").style.display="flex";

  $("#propSave").onclick=()=>{
    feat.setProperties({
      name: $("#f_name").value.trim(),
      category: $("#f_category").value.trim(),
      hours: $("#f_hours").value.trim(),
      level: $("#f_level").value.trim(),
      desc: $("#f_desc").value.trim(),
      image: $("#f_image").value.trim()
    });
    saveLocal($("#layerSel").value, tgt());
    $("#propModal").style.display="none";
    clearInteractions(); // form kapanƒ±nca etkile≈üimleri kapat
    toast("√ñzellikler kaydedildi");
  };
  $("#propCancel").onclick=()=>{
    $("#propModal").style.display="none";
    clearInteractions();
  };
}

/* ===================== ƒ∞ndir / Y√ºkle / Temizle ===================== */
$("#expIndoor").onclick = ()=> dl(gjFromLayer(indoorLayer),"indoor.json");
$("#expOutdoor").onclick = ()=> dl(gjFromLayer(outdoorLayer),"outdoor.json");

$("#imp").addEventListener("change", async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt=await file.text(); const json=JSON.parse(txt);
    const layer=tgt(); loadGJ(layer,json); saveLocal($("#layerSel").value, layer);
    toast("JSON y√ºklendi");
  }catch{ alert("Ge√ßersiz JSON"); }
  e.target.value="";
});

$("#clearLocal").onclick=()=>{
  if(confirm("Tarayƒ±cƒ± yerel verisi silinsin mi?")){
    localStorage.removeItem("indoor"); localStorage.removeItem("outdoor");
    toast("Yerel veri temizlendi");
  }
};
</script>
</body>
</html>
