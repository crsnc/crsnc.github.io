<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir ‚Äì Indoor & Outdoor Harita</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <style>
    :root{ --shadow:0 8px 24px rgba(0,0,0,.16); --muted:#6b7280; }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:fixed; inset:0}

    /* Attribution'u k√º√ß√ºk ve sade yap + collapse d√ºƒümesini gizle */
    .ol-attribution{font-size:10px; opacity:.85}
    .ol-attribution button{display:none}

    /* √úst bar */
    .toolbar{
      position:fixed; left:12px; right:12px; top:12px; z-index:1000;
      background:#fff; border-radius:12px; padding:8px; box-shadow:var(--shadow);
    }
    .row{display:flex; align-items:center; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
    .row::-webkit-scrollbar{display:none}
    .row>*{flex:0 0 auto}
    input[type="search"]{min-width:160px; width:52vw; max-width:620px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:10px 12px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}
    select{padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}

    /* Arama √∂nerileri */
    .results{position:absolute; left:12px; top:56px; z-index:1001; background:#fff; border:1px solid #e5e7eb; border-radius:10px; width:min(620px,92vw); max-height:44vh; overflow:auto; display:none; box-shadow:var(--shadow)}
    .results .item{padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}
    .results .hint{padding:8px 12px; color:var(--muted); font-size:12px; pointer-events:none}

    /* Popup */
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%); }
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}
    .muted{color:var(--muted)}
    .acc{position:fixed; right:12px; top:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
    @media (max-width:520px){ input[type="search"]{width:56vw; min-width:150px} }
  </style>
</head>
<body>

  <!-- √úst bar -->
  <div class="toolbar" role="toolbar" aria-label="Top bar">
    <div class="row">
      <input id="q" type="search" placeholder="Ara: restoran, spa, havuz‚Ä¶" />
      <button id="go" disabled>Git</button>

      <select id="lang" aria-label="Language">
        <option value="tr" selected>T√ºrk√ße</option>
        <option value="en">English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="de">Deutsch</option>
        <option value="pl">Polski</option>
      </select>

      <button id="pick">Haritadan Hedef</button>
      <button id="follow">üéØ ƒ∞zle: Kapalƒ±</button>
      <button id="toggleDetails">Detaylar: Kapalƒ±</button>
      <button id="reset">Sƒ±fƒ±rla</button>
    </div>
  </div>

  <!-- Arama sonu√ßlarƒ± -->
  <div id="results" class="results"></div>

  <!-- Konum doƒüruluk rozeti -->
  <div id="acc" class="acc" style="display:none"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none">
    <a href="#" id="popup-closer" class="ol-popup-closer">‚úï</a>
    <div id="popup-content"></div>
  </div>

  <div id="map" aria-label="Harita"></div>

<script>
/* ========= i18n ========= */
const I18N = {
  tr:{ searchPH:"Ara: restoran, spa, havuz‚Ä¶", go:"Git",
    ui:{ pick:"Haritadan Hedef", followOn:"ƒ∞zle: A√ßƒ±k", followOff:"ƒ∞zle: Kapalƒ±", detailsOn:"Detaylar: A√ßƒ±k", detailsOff:"Detaylar: Kapalƒ±", reset:"Sƒ±fƒ±rla", hint:"üîé Arama a√ßƒ±k: sadece e≈üle≈üenler g√∂steriliyor" },
    labels:{name:"ƒ∞sim", category:"T√ºr", hours:"Saat", level:"Kat", desc:"A√ßƒ±klama", dist:"Mesafe"},
    cats:{ pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"D√ºkkan", toilet:"WC",
           reception:"Resepsiyon", beach:"Plaj", kidsclub:"√áocuk Kul√ºb√º", elevator:"Asans√∂r", gate:"Kapƒ±", parking:"Otopark", shuttle:"Servis", gym:"Spor Salonu" } },
  en:{ searchPH:"Search: restaurant, spa, pool‚Ä¶", go:"Go",
    ui:{ pick:"Pick on Map", followOn:"Follow: On", followOff:"Follow: Off", detailsOn:"Details: On", detailsOff:"Details: Off", reset:"Reset", hint:"üîé Search is active: only matches are shown" },
    labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description", dist:"Distance"},
    cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet",
           reception:"Reception", beach:"Beach", kidsclub:"Kids Club", elevator:"Elevator", gate:"Gate", parking:"Parking", shuttle:"Shuttle", gym:"Gym" } },
  ru:{ searchPH:"–ü–æ–∏—Å–∫: —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å–ø–∞, –±–∞—Å—Å–µ–π–Ω‚Ä¶", go:"–ü–æ–µ—Ö–∞–ª–∏",
    ui:{ pick:"–í—ã–±—Ä–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ", followOn:"–°–ª–µ–¥–∏—Ç—å: –í–∫–ª", followOff:"–°–ª–µ–¥–∏—Ç—å: –í—ã–∫–ª", detailsOn:"–î–µ—Ç–∞–ª–∏: –í–∫–ª", detailsOff:"–î–µ—Ç–∞–ª–∏: –í—ã–∫–ª", reset:"–°–±—Ä–æ—Å", hint:"üîé –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–µ–Ω: –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è" },
    labels:{name:"–ù–∞–∑–≤–∞–Ω–∏–µ", category:"–¢–∏–ø", hours:"–ß–∞—Å—ã", level:"–≠—Ç–∞–∂", desc:"–û–ø–∏—Å–∞–Ω–∏–µ", dist:"–î–∏—Å—Ç–∞–Ω—Ü–∏—è"},
    cats:{ pool:"–ë–∞—Å—Å–µ–π–Ω", restaurant:"–†–µ—Å—Ç–æ—Ä–∞–Ω", spa:"–°–ø–∞", bar:"–ë–∞—Ä", cafe:"–ö–∞—Ñ–µ", shop:"–ú–∞–≥–∞–∑–∏–Ω", toilet:"–¢—É–∞–ª–µ—Ç",
           reception:"–†–µ—Å–µ–ø—à–Ω", beach:"–ü–ª—è–∂", kidsclub:"–î–µ—Ç—Å–∫–∏–π –∫–ª—É–±", elevator:"–õ–∏—Ñ—Ç", gate:"–í—Ö–æ–¥", parking:"–ü–∞—Ä–∫–æ–≤–∫–∞", shuttle:"–®–∞—Ç—Ç–ª", gym:"–¢—Ä–µ–Ω–∞–∂—ë—Ä–Ω—ã–π –∑–∞–ª" } },
  de:{ searchPH:"Suche: Restaurant, Spa, Pool‚Ä¶", go:"Los",
    ui:{ pick:"Ziel auf Karte", followOn:"Folgen: Ein", followOff:"Folgen: Aus", detailsOn:"Details: An", detailsOff:"Details: Aus", reset:"Zur√ºcksetzen", hint:"üîé Suche aktiv: es werden nur Treffer angezeigt" },
    labels:{name:"Name", category:"Art", hours:"Zeiten", level:"Etage", desc:"Beschreibung", dist:"Entfernung"},
    cats:{ pool:"Schwimmbad", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Caf√©", shop:"Laden", toilet:"WC",
           reception:"Rezeption", beach:"Strand", kidsclub:"Kinderclub", elevator:"Aufzug", gate:"Tor", parking:"Parkplatz", shuttle:"Shuttle", gym:"Fitness" } },
  pl:{ searchPH:"Szukaj: restauracja, spa, basen‚Ä¶", go:"Id≈∫",
    ui:{ pick:"Wybierz na mapie", followOn:"≈öled≈∫: W≈Ç.", followOff:"≈öled≈∫: Wy≈Ç.", detailsOn:"Szczeg√≥≈Çy: W≈Ç.", detailsOff:"Szczeg√≥≈Çy: Wy≈Ç.", reset:"Reset", hint:"üîé Wyszukiwanie aktywne: wy≈õwietlane sƒÖ tylko trafienia" },
    labels:{name:"Nazwa", category:"Typ", hours:"Godziny", level:"Poziom", desc:"Opis", dist:"Dystans"},
    cats:{ pool:"Basen", restaurant:"Restauracja", spa:"Spa", bar:"Bar", cafe:"Kawiarnia", shop:"Sklep", toilet:"Toaleta",
           reception:"Recepcja", beach:"Pla≈ºa", kidsclub:"Klub dzieciƒôcy", elevator:"Winda", gate:"Brama", parking:"Parking", shuttle:"Bus", gym:"Si≈Çownia" } }
};
let LANG = localStorage.getItem("lang") || "tr";
const t = () => I18N[LANG] || I18N.tr;
const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* e≈üanlamlƒ±lar */
const SYNONYMS = {
  pool:['havuz','pool','basen','–±–∞—Å—Å–µ–π–Ω','schwimmbad'],
  restaurant:['restoran','restaurant','restauracja','—Ä–µ—Å—Ç–æ—Ä–∞–Ω','gastst√§tte'],
  spa:['spa','wellness','—Å–ø–∞'],
  bar:['bar','barƒ±','–±–∞—Ä'],
  cafe:['cafe','caf√©','kafe','–∫–∞—Ñ–µ','kawiarnia'],
  shop:['shop','store','market','magaza','sklep','–º–∞–≥–∞–∑–∏–Ω','laden'],
  toilet:['wc','toilet','tuvalet','restroom','toaleta','—Ç—É–∞–ª–µ—Ç'],
  reception:['reception','resepsiyon','recepcja','—Ä–µ—Ü–µ–ø—Ü–∏—è'],
  beach:['beach','plaj','pla≈ºa','–ø–ª—è–∂','strand'],
  kidsclub:['kids club','kidsclub','√ßocuk','miniclub','–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±','kinderclub'],
  elevator:['elevator','lift','asans√∂r','aufzug','–ª–∏—Ñ—Ç','winda'],
  gate:['gate','kapƒ±','giri≈ü','brama','–≤–æ—Ä–æ—Ç–∞'],
  parking:['parking','park','otopark','parkplatz'],
  shuttle:['shuttle','servis','bus'],
  gym:['gym','fitness','spor','si≈Çownia']
};
const KEYWORD_TO_CAT = (()=>{ const m={}; Object.entries(SYNONYMS).forEach(([k,a])=>a.forEach(w=>m[norm(w)]=k)); return m; })();

/* ========= Map ========= */
const base = new ol.layer.Tile({
  source: new ol.source.OSM({
    attributions: '¬© aihotelstech ¬∑ ¬© OpenStreetMap contributors'
  })
});
const indoorSource  = new ol.source.Vector();
const outdoorSource = new ol.source.Vector();

let showAllDetails=false;
const FEATURED=new Set(['reception','restaurant','spa','pool','beach','bar','toilet','kidsclub','elevator','gate','parking','shuttle','shop']);
let searchIds=null;

function styleFactory(kind){
  return f=>{
    if(f.get('src')!==kind) return null;
    if(Array.isArray(searchIds)){
      const hit = searchIds.includes(f.ol_uid) || searchIds.includes(f.getId());
      return hit ? styleFor(f,1) : null;
    }
    const cat=(f.get('category')||'').toLowerCase();
    if(!showAllDetails && !FEATURED.has(cat)) return null;
    return styleFor(f,1);
  };
}
function styleFor(f,dim){
  const g=f.getGeometry();
  if(g.getType()==='Point'){
    return new ol.style.Style({
      image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:`rgba(249,65,68,${0.95*dim})`}), stroke:new ol.style.Stroke({color:`rgba(193,18,31,${1*dim})`,width:2})})
    });
  }
  return new ol.style.Style({ stroke:new ol.style.Stroke({color:`rgba(37,99,235,${1*dim})`,width:2}), fill:new ol.style.Fill({color:`rgba(37,99,235,${.10*dim})`}) });
}

const indoorLayer  = new ol.layer.VectorImage({ source: indoorSource,  style: styleFactory('indoor') });
const outdoorLayer = new ol.layer.VectorImage({ source: outdoorSource, style: styleFactory('outdoor') });

const map = new ol.Map({
  target:'map',
  layers:[base, indoorLayer, outdoorLayer],
  view:new ol.View({center: ol.proj.fromLonLat([31.8046,36.6002]), zoom:16, enableRotation:true})
});
map.addControl(new ol.control.Rotate());
map.addControl(new ol.control.Attribution({collapsible:false}));

/* ========= UI ========= */
const $ = id=>document.getElementById(id);
const q=$('q'), go=$('go'), langSel=$('lang'),
      pick=$('pick'), followBtn=$('follow'), toggleDetails=$('toggleDetails'), resetBtn=$('reset'),
      results=$('results'), acc=$('acc');
const popupEl=$('popup'), popupCloser=$('popup-closer'), popupContent=$('popup-content');
const popupOverlay=new ol.Overlay({element:popupEl, autoPan:{animation:{duration:200}}});
map.addOverlay(popupOverlay);
popupCloser.addEventListener('click',e=>{e.preventDefault(); hidePopup();});

function setSearchUIState(active){
  toggleDetails.disabled = active;
  toggleDetails.title = active ? (t().ui.hint) : '';
}

/* ========= Veri ========= */
const fmt=new ol.format.GeoJSON();
let allFeats=[];
(async function loadJSONs(){
  const [indoor, outdoor] = await Promise.all([
    fetch('indoor.json').then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
   ,fetch('outdoor.json').then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
  ]);
  indoorSource.clear(); outdoorSource.clear();
  const add=(src,gj,kind)=>{ const fs=fmt.readFeatures(gj,{featureProjection:'EPSG:3857',dataProjection:'EPSG:4326'}); fs.forEach(f=>f.set('src',kind)); src.addFeatures(fs); };
  add(indoorSource,indoor,'indoor'); add(outdoorSource,outdoor,'outdoor');
  allFeats = indoorSource.getFeatures().concat(outdoorSource.getFeatures());
  if(allFeats.length){ const ext=ol.extent.extend(indoorSource.getExtent(), outdoorSource.getExtent()); if(ext && ext.every(isFinite)) map.getView().fit(ext,{padding:[80,80,80,80], maxZoom:19}); }
  applyLang();
})();

/* ========= Dil ========= */
function applyLang(){
  const L=t();
  q.placeholder=L.searchPH; go.textContent=L.go;
  pick.textContent=L.ui.pick;
  followBtn.textContent = followState ? L.ui.followOn : L.ui.followOff;
  toggleDetails.textContent = showAllDetails ? L.ui.detailsOn : L.ui.detailsOff;
  resetBtn.textContent=L.ui.reset;
  localStorage.setItem('lang',LANG);
  if(currentPopupFeature && popupOverlay.getPosition()) popupContent.innerHTML=renderPopup(currentPopupFeature);
}
langSel.value=LANG;
langSel.addEventListener('change',()=>{ LANG=langSel.value; applyLang(); });

/* ========= Arama ========= */
function detectCategory(qs){
  const nq=norm(qs), dict=I18N[LANG]?.cats||{};
  for(const [k,label] of Object.entries(dict)){ if(norm(label).includes(nq) || nq.includes(norm(label))) return k; }
  return KEYWORD_TO_CAT[nq] || null;
}
q.addEventListener('input', ()=>{
  const val=(q.value||'').trim(); 
  if(!val){ searchIds=null; redraw(); results.style.display='none'; setSearchUIState(false); return; }

  const qn=norm(val); const maybeCat=detectCategory(val);
  const hits=allFeats.filter(f=>{
    const p=f.getProperties(); const cat=(p.category||'').toLowerCase();
    if(maybeCat && cat===maybeCat) return true;
    const names=[p.name,p.name_tr,p.name_en,p.name_ru,p.name_de,p.name_pl].filter(Boolean).map(norm);
    if(names.some(n=>n.includes(qn))) return true;
    const ex=[p.desc,p['desc_'+LANG],p.level,p['level_'+LANG],p.hours,p['hours_'+LANG]].filter(Boolean).map(norm);
    return ex.some(d=>d.includes(qn));
  });
  showResults(hits, maybeCat);
  searchIds = hits.map(f=> f.ol_uid || f.getId());
  redraw();
  setSearchUIState(true);
});
q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ const first=results.querySelector('.item'); if(first){ first.click(); e.preventDefault(); } } });

function showResults(list,cat){
  results.innerHTML='';
  // k√º√ß√ºk ipucu
  const hint=document.createElement('div'); hint.className='hint'; hint.textContent=t().ui.hint; results.appendChild(hint);

  if(cat){
    const feats=allFeats.filter(f=> (f.get('category')||'').toLowerCase()===cat);
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<span>‚û§ ${(t().cats?.[cat] || cat)}</span> <small>${feats.length}</small>`;
    div.onclick=()=>{ 
      if(!feats.length) return;
      // kategoriye tƒ±klandƒ±ƒüƒ±nda: haritada SADECE bu kategori kalsƒ±n + zoom
      searchIds = feats.map(f=> f.ol_uid || f.getId());
      redraw();
      const ext=ol.extent.createEmpty(); feats.forEach(f=> ol.extent.extend(ext,f.getGeometry().getExtent()));
      map.getView().fit(ext,{padding:[80,80,80,80], maxZoom:18});
      results.style.display='none';
      setSearchUIState(true);
    };
    results.appendChild(div);
  }

  list.slice(0,60).forEach(f=>{
    const div=document.createElement('div'); div.className='item';
    const name= f.get('name_'+LANG) || f.get('name') || '(isimsiz)';
    const meta=[f.get('src')==='indoor'?'Indoor':'Outdoor', f.get('category')||'', f.get('level')||''].filter(Boolean).join(' ¬∑ ');
    div.innerHTML = `<span>${name}</span><small>${meta}</small>`;
    div.onclick=()=>{ focusFeature(f,true); setDestination(coordOfFeature(f)); results.style.display='none'; go.disabled=false; };
    results.appendChild(div);
  });
  results.style.display='block';
}

/* ========= Kalabalƒ±k azaltma ========= */
toggleDetails.onclick=()=>{ if(toggleDetails.disabled) return; showAllDetails=!showAllDetails; toggleDetails.textContent = showAllDetails ? t().ui.detailsOn : t().ui.detailsOff; redraw(); };
function redraw(){ indoorLayer.changed(); outdoorLayer.changed(); }

/* ========= Konum + takip ========= */
let userLayer=null,userPoint=null,accCircle=null,followState=false,watchId=null;
function ensureUserLayer(){
  if(userLayer) return;
  userPoint=new ol.Feature(new ol.geom.Point([0,0]));
  userPoint.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:'#1d4ed8'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})}) }));
  accCircle=new ol.Feature(new ol.geom.Circle([0,0],1));
  accCircle.setStyle(new ol.style.Style({ stroke:new ol.style.Stroke({color:'#1d4ed8',width:1}), fill:new ol.style.Fill({color:'rgba(29,78,216,.06)'}) }));
  userLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userPoint]}) }); map.addLayer(userLayer);
}
(function startWatch(){
  if(!('geolocation' in navigator)) return;
  try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId);}catch{}
  watchId=navigator.geolocation.watchPosition(pos=>{
    const c=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]); ensureUserLayer();
    userPoint.getGeometry().setCoordinates(c); accCircle.getGeometry().setCenter(c); accCircle.getGeometry().setRadius(pos.coords.accuracy||0);
    acc.textContent="¬±"+Math.round(pos.coords.accuracy||0)+" m"; acc.style.display='block'; if(followState) map.getView().animate({center:c,duration:200});
  },()=>{}, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
})();
followBtn.onclick=()=>{ followState=!followState; followBtn.textContent= followState ? t().ui.followOn : t().ui.followOff; if(followState && userPoint) map.getView().setCenter(userPoint.getGeometry().getCoordinates()); };

/* ========= Hedef & rota ========= */
let destLayer=null,destPoint=null,routeLayer=null,bearingLayer=null,pickMode=false;
function setDestination(coord){ if(!destLayer){ destPoint=new ol.Feature(new ol.geom.Point(coord)); destPoint.setStyle(new ol.style.Style({ image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#ef4444'}),stroke:new ol.style.Stroke({color:'#fff',width:1.8})}) })); destLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[destPoint]})}); map.addLayer(destLayer);} else destPoint.getGeometry().setCoordinates(coord); go.disabled=false; }
pick.onclick=()=>{ pickMode=!pickMode; pick.classList.toggle('active',pickMode); };
map.on('click',evt=>{
  if(pickMode){ setDestination(evt.coordinate); pickMode=false; pick.classList.remove('active'); return; }
  // √∂ƒüe tƒ±klama ‚Üí popup
  currentPopupFeature=null;
  [indoorLayer,outdoorLayer].forEach(layer=> map.forEachFeatureAtPixel(evt.pixel,(feature,lay)=>{ if(lay===layer) currentPopupFeature=feature; }));
  if(currentPopupFeature){ showPopup(currentPopupFeature, evt.coordinate); } else hidePopup();
});
function clearRouteAndBearing(){ if(routeLayer){map.removeLayer(routeLayer);routeLayer=null;} if(bearingLayer){map.removeLayer(bearingLayer);bearingLayer=null;} }
function routeToDestination(){
  if(!userPoint || !destPoint){ alert(LANG==='tr'?'Konum ve hedef gerekli.':'Need location and destination.'); return; }
  clearRouteAndBearing();
  const a=ol.proj.toLonLat(userPoint.getGeometry().getCoordinates()), b=ol.proj.toLonLat(destPoint.getGeometry().getCoordinates());
  const url=`https://router.project-osrm.org/route/v1/foot/${a[0]},${a[1]};${b[0]},${b[1]}?overview=full&geometries=geojson`;
  fetch(url).then(r=>r.json()).then(d=>{
    if(d && d.routes && d.routes.length){
      const line=new ol.geom.LineString(d.routes[0].geometry.coordinates).transform('EPSG:4326','EPSG:3857');
      const feat=new ol.Feature({geometry:line});
      routeLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[feat]}), style:new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})}) });
      map.addLayer(routeLayer); map.getView().fit(line.getExtent(),{padding:[60,60,60,60], maxZoom:18});
    }else drawBearingLine();
  }).catch(()=> drawBearingLine());
}
go.onclick=routeToDestination;
function drawBearingLine(){
  const a=userPoint.getGeometry().getCoordinates(), b=destPoint.getGeometry().getCoordinates();
  const line=new ol.geom.LineString([a,b]), feat=new ol.Feature({geometry:line});
  const arrow=new ol.style.Style({ geometry:new ol.geom.Point(b),
    image:new ol.style.RegularShape({points:3,radius:10,rotation:Math.atan2(b[1]-a[1],b[0]-a[0]), fill:new ol.style.Fill({color:'#16a34a'}),stroke:new ol.style.Stroke({color:'#fff',width:1})})
  });
  const aLL=ol.proj.toLonLat(a), bLL=ol.proj.toLonLat(b);
  const dist=Math.round(ol.sphere.getDistance(aLL,bLL));
  const label=new ol.style.Style({ geometry:new ol.geom.Point([(a[0]+b[0])/2,(a[1]+b[1])/2]),
    text:new ol.style.Text({ text:(dist>=1000?(dist/1000).toFixed(2)+' km':dist+' m'), offsetY:-12, padding:[3,6,3,6],
      backgroundFill:new ol.style.Fill({color:'rgba(255,255,255,.9)'}), backgroundStroke:new ol.style.Stroke({color:'#e5e7eb',width:1}), fill:new ol.style.Fill({color:'#111'}) })
  });
  bearingLayer=new ol.layer.Vector({ source:new ol.source.Vector({features:[feat]}), style:[ new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})}), arrow, label ] });
  map.addLayer(bearingLayer); map.getView().fit(line.getExtent(),{padding:[60,60,60,60], maxZoom:19});
}

/* ========= Popup ========= */
let currentPopupFeature=null;
function coordOfFeature(f){ const g=f.getGeometry(); if(g.getType()==='Point') return g.getCoordinates(); if(g.getType()==='Polygon') return g.getInteriorPoint().getCoordinates(); return g.getFirstCoordinate(); }
function renderPopup(f){
  const p=f.getProperties(), L=t();
  const name = p['name_'+LANG] || p.name || '';
  const catKey=(p.category||'').toLowerCase();
  const catLabel=L.cats[catKey] || p.category || '';
  const hours = p['hours_'+LANG] || p.hours || '';
  const level = p['level_'+LANG] || p.level || '';
  const desc  = p['desc_'+LANG]  || p.desc  || '';
  const img   = p['image_'+LANG] || p.image || '';
  return `<div style="min-width:220px">
    <div style="font-weight:600;margin-bottom:6px">${name}</div>
    ${catLabel?`<div class="badge" title="${L.labels.category}">${catLabel}</div>`:''}
    ${hours?`<div style="margin-top:6px"><small>${L.labels.hours}:</small> ${hours}</div>`:''}
    ${level?`<div><small>${L.labels.level}:</small> ${level}</div>`:''}
    ${desc?`<div style="margin-top:6px" class="muted">${desc}</div>`:''}
    ${/^https?:\/\//i.test(img)?`<div style="margin-top:6px"><img src="${img}" alt="" style="width:100%;max-height:140px;object-fit:cover;border-radius:8px"></div>`:''}
  </div>`;
}
function showPopup(f,coord){ currentPopupFeature=f; popupContent.innerHTML=renderPopup(f); popupEl.style.display='block'; popupOverlay.setPosition(coord); }
function hidePopup(){ popupEl.style.display='none'; popupOverlay.setPosition(undefined); currentPopupFeature=null; }

/* ========= Reset ========= */
resetBtn.onclick=()=>{
  hidePopup(); clearRouteAndBearing(); results.style.display='none';
  q.value=''; searchIds=null; redraw(); setSearchUIState(false);
  const ext=ol.extent.extend(indoorSource.getExtent(), outdoorSource.getExtent());
  if(ext && ext.every(isFinite)) map.getView().fit(ext,{padding:[80,80,80,80], maxZoom:17});
};

/* UX */
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ results.style.display='none'; hidePopup(); }});
applyLang();
</script>
</body>
</html>
