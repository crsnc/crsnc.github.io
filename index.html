<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Harita – Indoor/Outdoor (Misafir)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
<style>
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Arial}
  #map{height:100%}
  .toolbar{position:absolute;top:10px;left:10px;z-index:10;background:#fff;padding:6px;border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,.2);display:flex;gap:6px;align-items:center}
  .toolbar input{padding:10px;width:220px;border:1px solid #ddd;border-radius:6px}
  .toolbar button,.toolbar select{padding:10px;border:1px solid #ddd;border-radius:6px;background:#fff}
  .results{position:absolute;top:56px;left:10px;z-index:11;background:#fff;border:1px solid #ccc;border-radius:8px;width:220px;max-height:40vh;overflow:auto;display:none;box-shadow:0 8px 20px rgba(0,0,0,.15)}
  .results .item{padding:8px 10px;cursor:pointer}
  .results .item:hover{background:#f5f5f5}
  #popup{position:absolute;background:#fff;padding:10px;border-radius:10px;min-width:240px;box-shadow:0 8px 20px rgba(0,0,0,.2);display:none}
  #popup img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin:6px 0}
  #popup .ttl{font-weight:700;font-size:16px;margin-bottom:4px}
  #popup .muted{color:#666;font-size:12px}
</style>
</head>
<body>
<div id="map"></div>
<div class="toolbar">
  <input id="searchInput" placeholder="Ara: restoran, spa, havuz…">
  <select id="lang"><option value="tr">TR</option><option value="en">EN</option><option value="ru">RU</option></select>
  <button id="goBtn" disabled>Git</button>
  <button id="pickBtn">Hedef Seç</button>
</div>
<div id="results" class="results"></div>
<div id="popup"></div>

<script>
const fmt=new ol.format.GeoJSON();
/* Katmanlar */
function styleFor(f){
  const t=f.getGeometry().getType();
  const stroke=new ol.style.Stroke({color:"rgba(0,0,0,0.6)",width:2});
  const fill=new ol.style.Fill({color:"rgba(0,150,0,0.18)"});
  const circle=new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"rgba(200,0,0,1)"}),stroke:new ol.style.Stroke({color:"#fff",width:1})});
  return t==="Point" ? new ol.style.Style({image:circle}) : new ol.style.Style({stroke,fill});
}
const indoorLayer = new ol.layer.Vector({source:new ol.source.Vector(), style:styleFor});
const outdoorLayer= new ol.layer.Vector({source:new ol.source.Vector(), style:styleFor});

const map=new ol.Map({
  target:"map",
  layers:[ new ol.layer.Tile({source:new ol.source.OSM()}), indoorLayer, outdoorLayer ],
  view:new ol.View({center: ol.proj.fromLonLat([31.805,36.600]), zoom:17})
});

/* Veriyi dış dosyalardan yükle (sunucuya koyduğun JSON) */
async function loadFile(url){ const r=await fetch(url,{cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }
(async ()=>{
  const indoor = await loadFile("indoor.json")  || {"type":"FeatureCollection","features":[]};
  const outdoor= await loadFile("outdoor.json") || {"type":"FeatureCollection","features":[]};
  indoorLayer.getSource().addFeatures(fmt.readFeatures(indoor,{featureProjection:"EPSG:3857"}));
  outdoorLayer.getSource().addFeatures(fmt.readFeatures(outdoor,{featureProjection:"EPSG:3857"}));
})();

/* Arama */
const $=s=>document.querySelector(s);
const searchInput=$("#searchInput"); const resultsEl=$("#results");
let selectedFeature=null;
function allFeats(){ return indoorLayer.getSource().getFeatures().concat(outdoorLayer.getSource().getFeatures()); }
function showResults(list){
  resultsEl.innerHTML=""; if(!list.length){resultsEl.style.display="none";return;}
  list.forEach(f=>{
    const div=document.createElement("div");
    const name=f.get("name")||"(isimsiz)"; const cat=f.get("category")||"";
    div.className="item"; div.textContent=cat?`${name} (${cat})`:name;
    div.onclick=()=>{
      selectedFeature=f; searchInput.value=name;
      map.getView().fit(f.getGeometry().getExtent(),{maxZoom:19});
      resultsEl.style.display="none"; $("#goBtn").disabled=false;
      const first=f.getGeometry().getFirstCoordinate?f.getGeometry().getFirstCoordinate():ol.extent.getCenter(f.getGeometry().getExtent());
      setDestination(first);
    };
    resultsEl.appendChild(div);
  });
  resultsEl.style.display="block";
}
searchInput.addEventListener("input",()=>{
  const val=searchInput.value.toLowerCase().trim();
  if(!val){resultsEl.style.display="none";return;}
  const m=allFeats().filter(f=>((f.get("name")||"") + " " + (f.get("category")||"")).toLowerCase().includes(val));
  showResults(m);
});

/* Konum (görsel mavi nokta) */
let userMarker=null, accCircle=null;
const locationLayer=new ol.layer.Vector({source:new ol.source.Vector()}); map.addLayer(locationLayer);
navigator.geolocation.watchPosition(pos=>{
  const c=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
  if(!userMarker){
    userMarker=new ol.Feature(new ol.geom.Point(c));
    userMarker.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#007bff"}),stroke:new ol.style.Stroke({color:"#fff",width:1.5})})}));
    accCircle=new ol.Feature(new ol.geom.Circle(c,pos.coords.accuracy));
    accCircle.setStyle(new ol.style.Style({stroke:new ol.style.Stroke({color:"#007bff",width:1}),fill:new ol.style.Fill({color:"rgba(0,123,255,0.05)"})}));
    locationLayer.getSource().addFeatures([accCircle,userMarker]);
  }else{
    userMarker.getGeometry().setCoordinates(c);
    accCircle.getGeometry().setCenter(c);
    accCircle.getGeometry().setRadius(pos.coords.accuracy);
  }
},{enableHighAccuracy:true,maximumAge:0,timeout:10000});

/* Hedef seç + navigasyon (OSRM foot) */
let destMarker=null, routeLayer=null;
function setDestination(coords){
  if(!destMarker){
    destMarker=new ol.Feature(new ol.geom.Point(coords));
    destMarker.setStyle(new ol.style.Style({image:new ol.style.Circle({radius:6,fill:new ol.style.Fill({color:"red"}),stroke:new ol.style.Stroke({color:"#fff",width:1.5})})}));
    const layer=new ol.layer.Vector({source:new ol.source.Vector({features:[destMarker]})});
    map.addLayer(layer);
  }else destMarker.getGeometry().setCoordinates(coords);
  $("#goBtn").disabled=false;
}
let pickMode=false;
$("#pickBtn").onclick=()=>{ pickMode=!pickMode; $("#pickBtn").classList.toggle("active",pickMode); };
map.on("click",e=>{ if(pickMode){ setDestination(e.coordinate); pickMode=false; $("#pickBtn").classList.remove("active"); }});
$("#goBtn").onclick=()=>{
  if(!userMarker || !destMarker) return alert("Konum ve hedef seçilmeli");
  const a=ol.proj.toLonLat(userMarker.getGeometry().getCoordinates());
  const b=ol.proj.toLonLat(destMarker.getGeometry().getCoordinates());
  const url=`https://router.project-osrm.org/route/v1/foot/${a[0]},${a[1]};${b[0]},${b[1]}?overview=full&geometries=geojson`;
  fetch(url).then(r=>r.json()).then(d=>{
    if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
    if(d.routes && d.routes.length){
      const line=new ol.geom.LineString(d.routes[0].geometry.coordinates).transform("EPSG:4326","EPSG:3857");
      const feat=new ol.Feature({geometry:line});
      routeLayer=new ol.layer.Vector({
        source:new ol.source.Vector({features:[feat]}),
        style:new ol.style.Style({stroke:new ol.style.Stroke({color:"blue",width:4})})
      });
      map.addLayer(routeLayer);
      const dist=(d.routes[0].distance/1000).toFixed(2), time=Math.round(d.routes[0].duration/60);
      alert(`Mesafe: ${dist} km\nSüre: ${time} dk`);
    }else alert("Rota bulunamadı");
  }).catch(()=>alert("Rota hesaplanamadı"));
};

/* Popup (bilgi kartı) */
const popupEl=$("#popup");
const overlay=new ol.Overlay({element:popupEl,autoPan:true,offset:[0,-12]}); map.addOverlay(overlay);
map.on("singleclick",evt=>{
  let hit=false;
  map.forEachFeatureAtPixel(evt.pixel,(f,l)=>{
    const p=f.getProperties();
    if(p && (p.name||p.category||p.hours||p.desc||p.image)){
      hit=true;
      popupEl.innerHTML=`
        <div class="ttl">${p.name||"(isimsiz)"}</div>
        ${p.image?`<img src="${p.image}" alt="">`:""}
        ${p.category?`<div class="muted">Kategori: ${p.category}</div>`:""}
        ${p.hours?`<div class="muted">Saatler: ${p.hours}</div>`:""}
        ${p.level?`<div class="muted">Seviye: ${p.level}</div>`:""}
        ${p.desc?`<div style="margin-top:6px">${p.desc}</div>`:""}
      `;
      popupEl.style.display="block"; overlay.setPosition(evt.coordinate);
    }
  },{layerFilter:l=>(l===indoorLayer||l===outdoorLayer)});
  if(!hit) popupEl.style.display="none";
});
</script>
</body>
</html>
