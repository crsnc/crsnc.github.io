<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Misafir ‚Äì Indoor & Outdoor Harita</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <style>
    :root{
      --shadow:0 8px 24px rgba(0,0,0,.16);
      --muted:#6b7280;
      --brand:#2563eb;
      --danger:#dc2626;
    }
    html,body{height:100%;margin:0}
    body{font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #map{position:fixed; inset:0}

    /* √úst bar */
    .toolbar{
      position:fixed; left:12px; right:12px; top:12px; z-index:1000;
      background:#fff; border-radius:12px; padding:8px; box-shadow:var(--shadow);
    }
    .row{display:flex; align-items:center; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
    .row::-webkit-scrollbar{display:none}
    .row>*{flex:0 0 auto}
    input[type="search"]{min-width:160px; width:44vw; max-width:520px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px}
    button,.btn{padding:8px 10px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:10px; cursor:pointer}
    button:active{transform:translateY(1px)}
    select{padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; background:#fff}

    /* Arama √∂nerileri */
    .results{position:absolute; left:12px; top:52px; z-index:1001; background:#fff; border:1px solid #e5e7eb; border-radius:10px; width:min(520px,92vw); max-height:42vh; overflow:auto; display:none; box-shadow:var(--shadow)}
    .results .item{padding:8px 10px; cursor:pointer; display:flex; justify-content:space-between; gap:8px}
    .results .item small{color:var(--muted)}
    .results .item:hover{background:#f1f5f9}

    /* Popup */
    .ol-popup{position:absolute; background:#fff; padding:10px; border-radius:10px; border:1px solid #e5e7eb; min-width:220px; box-shadow:var(--shadow); transform:translate(-50%,-100%); }
    .ol-popup-closer{position:absolute; right:8px; top:6px; text-decoration:none; color:#9ca3af}
    .badge{display:inline-block; padding:.15rem .45rem; border-radius:999px; background:#eef2ff; border:1px solid #dfe6ff; font-size:12px}
    .muted{color:var(--muted)}

    .acc{position:fixed; right:12px; top:12px; z-index:1000; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:12px; box-shadow:var(--shadow)}
    @media (max-width:520px){ input[type="search"]{width:56vw; min-width:150px} }
  </style>
</head>
<body>

  <!-- √úst bar -->
  <div class="toolbar" role="toolbar" aria-label="√úst √ßubuk">
    <div class="row">
      <input id="q" type="search" placeholder="Ara: restoran, spa‚Ä¶" />
      <button id="go" disabled>Git</button>

      <select id="preset" title="Hedef se√ß">
        <option value="">Hedef Se√ß</option>
      </select>

      <select id="lang" aria-label="Dil">
        <option value="tr" selected>T√ºrk√ße</option>
        <option value="en">English</option>
        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        <option value="de">Deutsch</option>
        <option value="pl">Polski</option>
      </select>

      <button id="pick">Haritadan Hedef</button>
      <button id="follow">üéØ ƒ∞zle: Kapalƒ±</button>
      <button id="reset">Sƒ±fƒ±rla</button>
    </div>
  </div>

  <!-- Arama sonu√ßlarƒ± -->
  <div id="results" class="results"></div>

  <!-- Konum doƒüruluk rozeti -->
  <div id="acc" class="acc" style="display:none"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none">
    <a href="#" id="popup-closer" class="ol-popup-closer">‚úï</a>
    <div id="popup-content"></div>
  </div>

  <div id="map" aria-label="Harita"></div>

<script>
/* ========= 1) i18n ========= */
const I18N = {
  tr:{ searchPH:"Ara: restoran, spa, havuz‚Ä¶", go:"Git", choose:"Hedef Se√ß",
      labels:{name:"ƒ∞sim", category:"T√ºr", hours:"Saat", level:"Kat", desc:"A√ßƒ±klama", dist:"Mesafe", bearing:"Y√∂n"},
      cats:{ pool:"Havuz", restaurant:"Restoran", spa:"Spa", bar:"Bar", cafe:"Kafe", shop:"D√ºkkan", toilet:"WC" } },
  en:{ searchPH:"Search: restaurant, spa, pool‚Ä¶", go:"Go", choose:"Pick a place",
      labels:{name:"Name", category:"Type", hours:"Hours", level:"Level", desc:"Description", dist:"Distance", bearing:"Bearing"},
      cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Cafe", shop:"Shop", toilet:"Toilet" } },
  ru:{ searchPH:"–ü–æ–∏—Å–∫: —Ä–µ—Å—Ç–æ—Ä–∞–Ω, —Å–ø–∞, –±–∞—Å—Å–µ–π–Ω‚Ä¶", go:"–ü–æ–µ—Ö–∞–ª–∏", choose:"–í—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ",
      labels:{name:"–ù–∞–∑–≤–∞–Ω–∏–µ", category:"–¢–∏–ø", hours:"–ß–∞—Å—ã", level:"–≠—Ç–∞–∂", desc:"–û–ø–∏—Å–∞–Ω–∏–µ", dist:"–î–∏—Å—Ç–∞–Ω—Ü–∏—è", bearing:"–ê–∑–∏–º—É—Ç"},
      cats:{ pool:"–ë–∞—Å—Å–µ–π–Ω", restaurant:"–†–µ—Å—Ç–æ—Ä–∞–Ω", spa:"–°–ø–∞", bar:"–ë–∞—Ä", cafe:"–ö–∞—Ñ–µ", shop:"–ú–∞–≥–∞–∑–∏–Ω", toilet:"–¢—É–∞–ª–µ—Ç" } },
  de:{ searchPH:"Suche: Restaurant, Spa, Pool‚Ä¶", go:"Los", choose:"Ziel w√§hlen",
      labels:{name:"Name", category:"Art", hours:"Zeiten", level:"Etage", desc:"Beschreibung", dist:"Entfernung", bearing:"Kurs"},
      cats:{ pool:"Pool", restaurant:"Restaurant", spa:"Spa", bar:"Bar", cafe:"Caf√©", shop:"Laden", toilet:"WC" } },
  pl:{ searchPH:"Szukaj: restauracja, spa, basen‚Ä¶", go:"Id≈∫", choose:"Wybierz cel",
      labels:{name:"Nazwa", category:"Typ", hours:"Godziny", level:"Poziom", desc:"Opis", dist:"Dystans", bearing:"Kierunek"},
      cats:{ pool:"Basen", restaurant:"Restauracja", spa:"Spa", bar:"Bar", cafe:"Kawiarnia", shop:"Sklep", toilet:"Toaleta" } }
};
let LANG = localStorage.getItem("lang") || "tr";
function t(){ return I18N[LANG] || I18N.tr; }

/* ========= 2) Map ========= */
const base = new ol.layer.Tile({ source: new ol.source.OSM() });

const dataSource = new ol.source.Vector();   // indoor+outdoor birle≈üik g√∂rsel katman
const dataLayer  = new ol.layer.Vector({
  source:dataSource,
  style: f=>{
    const g=f.getGeometry();
    if(g.getType()==="Point"){
      return new ol.style.Style({
        image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:'#f94144'}), stroke:new ol.style.Stroke({color:'#c1121f',width:2})})
      });
    }
    return new ol.style.Style({
      stroke:new ol.style.Stroke({color:'#2563eb',width:2}),
      fill:new ol.style.Fill({color:'rgba(37,99,235,.10)'})
    });
  }
});

const map = new ol.Map({
  target:'map',
  layers:[base, dataLayer],
  view:new ol.View({center: ol.proj.fromLonLat([31.8046,36.6002]), zoom:16, enableRotation:true}),
  controls: ol.control.defaults().extend([ new ol.control.Rotate() ])
});
// (Mobilde iki parmakla, masa√ºst√ºnde Alt+Shift ile d√∂nd√ºrme varsayƒ±lan etkile≈üimde a√ßƒ±ktƒ±r)

/* ========= 3) UI elemanlarƒ± ========= */
const $ = id=>document.getElementById(id);
const $q=$('q'), $go=$('go'), $preset=$('preset'), $lang=$('lang'),
      $pick=$('pick'), $follow=$('follow'), $reset=$('reset'),
      $results=$('results'), $acc=$('acc');
const $popup=$('popup'), $popupCloser=$('popup-closer'), $popupContent=$('popup-content');

const popupOverlay = new ol.Overlay({ element:$popup, autoPan:{animation:{duration:200}} });
map.addOverlay(popupOverlay);
$popupCloser.addEventListener('click',e=>{e.preventDefault(); hidePopup();});

/* ========= 4) Veri y√ºkleme (repo k√∂k√º) ========= */
const fmt = new ol.format.GeoJSON();
let allFeats = []; // OL Feature dizisi

async function loadJSONs(){
  // indoor ve outdoor aynƒ± klas√∂rde (repo k√∂k√º)
  const [indoor, outdoor] = await Promise.all([
    fetch('indoor.json').then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
    ,fetch('outdoor.json').then(r=>r.ok?r.json():{type:'FeatureCollection',features:[]}).catch(()=>({type:'FeatureCollection',features:[]}))
  ]);

  dataSource.clear();
  const add = (gj,srcName)=>{
    const fs = fmt.readFeatures(gj,{featureProjection:'EPSG:3857', dataProjection:'EPSG:4326'});
    fs.forEach(f=>f.set('src', srcName));
    dataSource.addFeatures(fs);
  };
  add(indoor,'indoor');
  add(outdoor,'outdoor');
  allFeats = dataSource.getFeatures();

  if(allFeats.length){
    const ext = dataSource.getExtent();
    if(ext && ext.every(isFinite)) map.getView().fit(ext,{padding:[80,80,80,80], maxZoom:19});
  }
  rebuildPreset();
  applyLang();
}
loadJSONs();

/* ========= 5) √áok dillilik ========= */
function applyLang(){
  const L10N=t();
  $q.placeholder=L10N.searchPH;
  $go.textContent=L10N.go;
  $preset.options[0].textContent=L10N.choose;
  localStorage.setItem('lang',LANG);

  // a√ßƒ±k popup varsa i√ßeriƒüini yenile
  if(currentPopupFeature && popupOverlay.getPosition()){
    $popupContent.innerHTML = renderPopup(currentPopupFeature);
  }
  // preset sƒ±rasƒ±nƒ± dile g√∂re g√ºncelle
  rebuildPreset();
}
$lang.value=LANG;
$lang.addEventListener('change',()=>{ LANG=$lang.value; applyLang(); });

function renderPopup(feature){
  const p=feature.getProperties();
  const L10N=t();
  const name = p['name_'+LANG] || p.name || '';
  const catKey=(p.category||'').toLowerCase();
  const catLabel=L10N.cats[catKey] || p.category || '';
  const hours = p['hours_'+LANG] || p.hours || '';
  const level = p['level_'+LANG] || p.level || '';
  const desc  = p['desc_'+LANG]  || p.desc  || '';
  const img   = p.image && /^https?:\/\//i.test(p.image) ? p.image : '';

  return `
    <div style="min-width:220px">
      <div style="font-weight:600; margin-bottom:6px">${name}</div>
      ${catLabel?`<div class="badge" title="${L10N.labels.category}">${catLabel}</div>`:''}
      ${hours?`<div style="margin-top:6px"><small>${L10N.labels.hours}:</small> ${hours}</div>`:''}
      ${level?`<div><small>${L10N.labels.level}:</small> ${level}</div>`:''}
      ${desc?`<div style="margin-top:6px" class="muted">${desc}</div>`:''}
      ${img?`<div style="margin-top:6px"><img src="${img}" alt="" style="width:100%;max-height:140px;object-fit:cover;border-radius:8px"/></div>`:''}
    </div>
  `;
}

/* ========= 6) Arama + preset ========= */
function rebuildPreset(){
  // ilk satƒ±r hari√ß hepsini sil
  for(let i=$preset.options.length-1;i>=1;i--) $preset.remove(i);
  const arr = allFeats.slice().sort((a,b)=>{
    const na=(a.get('name_'+LANG)||a.get('name')||'').toLocaleLowerCase(LANG);
    const nb=(b.get('name_'+LANG)||b.get('name')||'').toLocaleLowerCase(LANG);
    return na.localeCompare(nb);
  });
  arr.forEach(f=>{
    const opt=document.createElement('option');
    opt.value = f.ol_uid || f.getId() || '';
    const cat = f.get('category') ? ` (${f.get('category')})` : '';
    opt.textContent = (f.get('name_'+LANG) || f.get('name') || '(isimsiz)') + cat;
    $preset.appendChild(opt);
  });
}

$preset.addEventListener('change',()=>{
  const id=$preset.value; if(!id) return;
  const f = allFeats.find(x=> String(x.ol_uid)===id || String(x.getId())===id);
  if(f){ focusFeature(f,true); setDestination(coordOfFeature(f)); }
});

$q.addEventListener('input', ()=>{
  const val=($q.value||'').toLowerCase().trim();
  if(!val){$results.style.display='none'; return;}
  const list=allFeats.filter(f=>{
    const p=f.getProperties();
    const name=(p['name_'+LANG]||p.name||'').toLowerCase();
    const cat =(p.category||'').toLowerCase();
    const lvl =(p['level_'+LANG]||p.level||'').toLowerCase();
    return name.includes(val) || cat.includes(val) || lvl.includes(val);
  });
  showResults(list);
});

function showResults(list){
  $results.innerHTML='';
  if(!list.length){$results.style.display='none'; return;}
  list.forEach(f=>{
    const div=document.createElement('div');
    div.className='item';
    const name= f.get('name_'+LANG) || f.get('name') || '(isimsiz)';
    const meta=[f.get('category')||'', f.get('level')||''].filter(Boolean).join(' ¬∑ ');
    div.innerHTML = `<span>${name}</span> <small>${meta}</small>`;
    div.onclick=()=>{ focusFeature(f,true); setDestination(coordOfFeature(f)); $results.style.display='none'; };
    $results.appendChild(div);
  });
  $results.style.display='block';
}

/* ========= 7) Konum (mavi nokta) + takip ========= */
let userLayer=null, userPoint=null, accCircle=null, follow=false, watchId=null;

function ensureUserLayer(){
  if(userLayer) return;
  userPoint=new ol.Feature(new ol.geom.Point([0,0]));
  userPoint.setStyle(new ol.style.Style({
    image:new ol.style.Circle({radius:6, fill:new ol.style.Fill({color:'#1d4ed8'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})})
  }));
  accCircle=new ol.Feature(new ol.geom.Circle([0,0],1));
  accCircle.setStyle(new ol.style.Style({
    stroke:new ol.style.Stroke({color:'#1d4ed8',width:1}),
    fill:new ol.style.Fill({color:'rgba(29,78,216,.06)'})
  }));
  userLayer = new ol.layer.Vector({ source:new ol.source.Vector({features:[accCircle,userPoint]}) });
  map.addLayer(userLayer);
}

function startWatch(){
  if(!('geolocation' in navigator)) return;
  try{ if(watchId!==null) navigator.geolocation.clearWatch(watchId);}catch{}
  watchId = navigator.geolocation.watchPosition(pos=>{
    const coord=ol.proj.fromLonLat([pos.coords.longitude,pos.coords.latitude]);
    ensureUserLayer();
    userPoint.getGeometry().setCoordinates(coord);
    accCircle.getGeometry().setCenter(coord);
    accCircle.getGeometry().setRadius(pos.coords.accuracy||0);
    $acc.textContent = "¬±"+Math.round(pos.coords.accuracy||0)+" m";
    $acc.style.display='block';
    if(follow) map.getView().animate({center:coord, duration:200});
  }, err=>{ console.warn('geo error',err); }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
}
startWatch();

$follow.onclick=()=>{
  follow=!follow;
  $follow.textContent = follow ? "üéØ ƒ∞zle: A√ßƒ±k" : "üéØ ƒ∞zle: Kapalƒ±";
  if(follow && userPoint) map.getView().setCenter(userPoint.getGeometry().getCoordinates());
};

/* ========= 8) Hedef se√ß & rota ========= */
let destLayer=null, destPoint=null, routeLayer=null, bearingLayer=null, pickMode=false;

function setDestination(coord3857){
  if(!destLayer){
    destPoint=new ol.Feature(new ol.geom.Point(coord3857));
    destPoint.setStyle(new ol.style.Style({
      image:new ol.style.Circle({radius:7, fill:new ol.style.Fill({color:'#ef4444'}), stroke:new ol.style.Stroke({color:'#fff',width:1.8})})
    }));
    destLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[destPoint]})});
    map.addLayer(destLayer);
  }else{
    destPoint.getGeometry().setCoordinates(coord3857);
  }
  $go.disabled = false;
}

$pick.onclick=()=>{
  pickMode=!pickMode;
  $pick.classList.toggle('active',pickMode);
};
map.on('click',evt=>{
  if(pickMode){
    setDestination(evt.coordinate);
    pickMode=false; $pick.classList.remove('active');
  }else{
    // veri √∂ƒüesine tƒ±klanƒ±nca popup a√ß
    currentPopupFeature=null;
    map.forEachFeatureAtPixel(evt.pixel,(feature,layer)=>{
      if(layer===dataLayer){ currentPopupFeature=feature; }
    });
    if(currentPopupFeature){
      showPopup(currentPopupFeature, evt.coordinate);
    }else{
      hidePopup();
    }
  }
});

$go.onclick = routeToDestination;

function routeToDestination(){
  if(!userPoint || !destPoint){
    alert(LANG==='tr'?'Konum ve hedef gerekli.':'Need location and destination.');
    return;
  }
  // √∂nce temizle
  clearRouteAndBearing();

  const userLL = ol.proj.toLonLat(userPoint.getGeometry().getCoordinates());
  const destLL = ol.proj.toLonLat(destPoint.getGeometry().getCoordinates());
  const url = `https://router.project-osrm.org/route/v1/foot/${userLL[0]},${userLL[1]};${destLL[0]},${destLL[1]}?overview=full&geometries=geojson`;

  // OSRM dene; olmazsa d√ºz √ßizgi + mesafe/y√∂n oku g√∂ster
  fetch(url).then(r=>r.json()).then(data=>{
    if(data && data.routes && data.routes.length){
      const coords=data.routes[0].geometry.coordinates;
      const line=new ol.geom.LineString(coords).transform('EPSG:4326','EPSG:3857');
      const feat=new ol.Feature({geometry:line});
      routeLayer=new ol.layer.Vector({
        source:new ol.source.Vector({features:[feat]}),
        style:new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})})
      });
      map.addLayer(routeLayer);
      map.getView().fit(line.getExtent(),{padding:[60,60,60,60], maxZoom:18});
    }else{
      drawBearingLine(); // fallback
    }
  }).catch(()=> drawBearingLine());
}

function clearRouteAndBearing(){
  if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
  if(bearingLayer){ map.removeLayer(bearingLayer); bearingLayer=null; }
}

function drawBearingLine(){
  // Basit √ßizgi + ok ucu + mesafe etiketi
  const a = userPoint.getGeometry().getCoordinates();
  const b = destPoint.getGeometry().getCoordinates();
  const line = new ol.geom.LineString([a,b]);
  const feat = new ol.Feature({geometry:line});

  // ok ucu (destte)
  const arrow = new ol.style.Style({
    geometry: new ol.geom.Point(b),
    image: new ol.style.RegularShape({
      points:3, radius:10, rotation: Math.atan2(b[1]-a[1], b[0]-a[0]),
      fill:new ol.style.Fill({color:'#16a34a'}), stroke:new ol.style.Stroke({color:'#fff',width:1})
    })
  });

  // mesafe etiketi
  const distMeters = Math.round(ol.sphere.getLength(new ol.geom.LineString([ol.proj.toLonLat(a), ol.proj.toLonLat(b)])));
  const label = new ol.style.Style({
    geometry: new ol.geom.Point([(a[0]+b[0])/2, (a[1]+b[1])/2]),
    text: new ol.style.Text({ text: (distMeters>=1000? (distMeters/1000).toFixed(2)+' km' : distMeters+' m'),
      offsetY:-12, padding:[3,6,3,6], backgroundFill:new ol.style.Fill({color:'rgba(255,255,255,.9)'}),
      backgroundStroke:new ol.style.Stroke({color:'#e5e7eb',width:1}), fill:new ol.style.Fill({color:'#111'})
    })
  });

  bearingLayer=new ol.layer.Vector({
    source:new ol.source.Vector({features:[feat]}),
    style:[ new ol.style.Style({stroke:new ol.style.Stroke({color:'#16a34a',width:4})}), arrow, label ]
  });
  map.addLayer(bearingLayer);
  map.getView().fit(line.getExtent(),{padding:[60,60,60,60], maxZoom:19});
}

/* ========= 9) Popup ========= */
let currentPopupFeature=null;
function coordOfFeature(f){
  const g=f.getGeometry();
  if(g.getType()==='Point') return g.getCoordinates();
  if(g.getType()==='Polygon') return g.getInteriorPoint().getCoordinates();
  return g.getFirstCoordinate();
}
function showPopup(feature, coord){
  currentPopupFeature=feature;
  $popupContent.innerHTML = renderPopup(feature);
  $popup.style.display='block';
  popupOverlay.setPosition(coord);
}
function hidePopup(){
  $popup.style.display='none';
  popupOverlay.setPosition(undefined);
  currentPopupFeature=null;
}

/* ========= 10) Odakla ========= */
function focusFeature(f, open=false){
  const g=f.getGeometry();
  const coord = coordOfFeature(f);
  map.getView().fit(g.getExtent(),{padding:[80,80,80,80], maxZoom:19});
  if(open){ showPopup(f, coord); }
}

/* ========= 11) Reset ========= */
$reset.onclick=()=>{
  hidePopup();
  clearRouteAndBearing();
  if(allFeats.length){
    const ext=dataSource.getExtent();
    map.getView().fit(ext,{padding:[80,80,80,80], maxZoom:17});
  }
  $results.style.display='none';
};

/* ========= 12) Dil ilk y√ºkleme ========= */
applyLang();

/* ========= 13) Eri≈üilebilirlik k√º√ß√ºk iyile≈ütirme ========= */
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){ $results.style.display='none'; hidePopup(); }
});
</script>
</body>
</html>
