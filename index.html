<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Akıllı Map – Otel Indoor/Outdoor</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<!-- Search: Leaflet Control Search (katman içi arama) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.css">
<script src="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.js"></script>

<!-- Locate (mavi nokta butonu) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css">
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<!-- Çizim/Düzenleme: Geoman -->
<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.css">
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@2.15.0/dist/leaflet-geoman.min.js"></script>

<style>
  html,body,#map{height:100%;margin:0}
  .ui{position:absolute;z-index:1000;left:10px;top:10px;background:#fff;padding:8px 10px;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,.12);font:14px system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;max-width:330px}
  .ui b{display:block;margin-bottom:4px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #99f;font-size:12px;margin-right:6px}
  .btn{background:#0066ff;color:#fff;border:none;border-radius:6px;padding:6px 10px;margin:4px 2px;cursor:pointer}
  .btn.secondary{background:#f3f4f6;color:#111;border:1px solid #d1d5db}
  .leaflet-control-container .leaflet-top.leaflet-left { margin-top:48px } /* arama/locate çakışmasın */
</style>
</head>
<body>
<div id="map"></div>

<div class="ui">
  <b>Akıllı Map</b>
  <div class="pill">Indoor</div><div class="pill">Outdoor</div><div class="pill">Blue Dot</div><div class="pill">Otel içi arama</div>
  <div style="margin-top:6px">
    <button class="btn secondary" id="fitBtn">Otele Odaklan</button>
    <button class="btn secondary" id="exportBtn">POI/Indoor Dışa Aktar</button>
    <button class="btn secondary" id="importBtn">POI/Indoor İçe Aktar</button>
  </div>
  <div style="font-size:12px;color:#555;margin-top:6px">
    Arama kutusu yalnızca tesis içindeki alan/POI adlarını listeler. Çizim araçlarıyla yeni POI/oda ekleyip kaydedebilirsin.
  </div>
</div>

<script>
/* =========================================================================
   0) OTEL POLİGONU — senin verdiğin GeoJSON (geometry)
   ========================================================================= */
const HOTEL_GEOMETRY = {
  "type":"Polygon",
  "coordinates":[[  // GeoJSON: [lng,lat]
    [31.80488563536983,36.60144809135009],
    [31.80141125277774,36.599560719072684],
    [31.806994242514662,36.59688713533359],
    [31.80828178115803,36.59899633325935],
    [31.80488563536983,36.60144809135009]
  ]]
};

/* =========================================================================
   1) BAŞLANGIÇ DEMO POI/INDOOR (yer tutucu — düzenleyebilirsin)
   - Indoor: polygon (level)    - Outdoor: point
   - Koordinatlar, otel merkezine göre yakın çevreye yerleştirilecek.
   ========================================================================= */
function demoData(center){
  const dLat = 0.00025, dLng = 0.00035; // ~25–35 m ofsetler
  const C = (dy,dx)=>[center.lng+dx, center.lat+dy]; // GeoJSON sırası [lng,lat]

  const INDOOR = {
    "type":"FeatureCollection",
    "features":[
      // Level 1 (zemin)
      {"type":"Feature","properties":{"id":"ind-lobi","name":"Lobi","level":1,"type":"room"},
       "geometry":{"type":"Polygon","coordinates":[[
         C(+dLat,+0), C(+dLat,+dLng), C(0,+dLng), C(0,+0), C(+dLat,+0)
       ]]}},
      {"type":"Feature","properties":{"id":"ind-resto","name":"Ana Restoran","level":1,"type":"restaurant"},
       "geometry":{"type":"Polygon","coordinates":[[
         C(+0.00005,+0.00050), C(+0.00005,+0.00085), C(-0.00020,+0.00085), C(-0.00020,+0.00050), C(+0.00005,+0.00050)
       ]]}},
      // Level -1 (spa)
      {"type":"Feature","properties":{"id":"ind-spa","name":"SPA","level":-1,"type":"spa"},
       "geometry":{"type":"Polygon","coordinates":[[
         C(-0.00020,-0.00010), C(-0.00020,+0.00015), C(-0.00045,+0.00015), C(-0.00045,-0.00010), C(-0.00020,-0.00010)
       ]]}}
    ]
  };

  const OUTDOOR = {
    "type":"FeatureCollection",
    "features":[
      {"type":"Feature","properties":{"id":"out-beachbar","name":"Beach Bar","type":"bar"},
       "geometry":{"type":"Point","coordinates":C(-0.00065,+0.00060)}},
      {"type":"Feature","properties":{"id":"out-mainpool","name":"Ana Havuz","type":"pool"},
       "geometry":{"type":"Point","coordinates":C(-0.00050,+0.00025)}},
      {"type":"Feature","properties":{"id":"out-disco","name":"Disco","type":"disco"},
       "geometry":{"type":"Point","coordinates":C(+0.00040,-0.00025)}},
      {"type":"Feature","properties":{"id":"out-gate","name":"Ana Giriş (Kapı)","type":"gate"},
       "geometry":{"type":"Point","coordinates":C(+0.00075,-0.00010)}}
    ]
  };

  return {INDOOR, OUTDOOR};
}

/* =========================================================================
   2) HARİTA
   ========================================================================= */
const map = L.map('map', { zoomControl:true }).setView([36.6005,31.8055], 17); // başlangıçta boş kalmasın
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);
osm.setOpacity(0.5);

/* =========================================================================
   3) OTEL SINIRI + MASKE/KİLİT
   ========================================================================= */
let hotelOutline = L.geoJSON(HOTEL_GEOMETRY, { style:{ color:'#0078ff', weight:2, fillOpacity:0.05 } }).addTo(map);
const hotelBounds = hotelOutline.getBounds().pad(0.03);
map.fitBounds(hotelBounds);

const maskGroup = L.layerGroup(); // toggleda doldurup boşaltacağız
function createMask(geom){
  const world = [[-90,-180],[-90,180],[90,180],[90,-180]];
  const toLatLngs = arr => arr.map(([lng,lat])=>[lat,lng]);
  const holes = [];
  if (geom.type==='Polygon') holes.push(toLatLngs(geom.coordinates[0]).slice().reverse());
  if (geom.type==='MultiPolygon') geom.coordinates.forEach(poly=>holes.push(toLatLngs(poly[0]).slice().reverse()));
  return L.polygon([world].concat(holes), { stroke:false, fill:true, fillColor:'#000', fillOpacity:0.35, interactive:false });
}
maskGroup.on('add', ()=>{
  maskGroup.clearLayers();
  maskGroup.addLayer(createMask(HOTEL_GEOMETRY));
  map.setMaxBounds(hotelBounds);
  map.options.maxBoundsViscosity = 1.0;
});
maskGroup.on('remove', ()=>{
  maskGroup.clearLayers();
  map.setMaxBounds(null);
});

/* =========================================================================
   4) INDOOR/OUTDOOR KATMANLAR + ARAMA İNDEKSİ
   ========================================================================= */
const levelGroups = new Map(); // level => LayerGroup
const outdoorGroup = L.layerGroup().addTo(map);
const indexLayer = L.layerGroup();        // sadece arama için (haritaya eklemiyoruz)

function roomStyle(){ return { color:'#0066ff', weight:1, fillOpacity:0.25 }; }
function onEachRoom(f,layer){
  const p=f.properties||{};
  const label = `${p.name || 'Oda'}${p.level!==undefined?` (Kat ${p.level})`:''}`;
  layer.bindPopup(label);
  layer.on('mouseover', e=>e.target.setStyle({weight:2}));
  layer.on('mouseout',  e=>e.target.setStyle({weight:1}));
  // Arama indeksi (sadece indexLayer'a, görünmez)
  const center = layer.getBounds().getCenter();
  const idx = L.marker(center,{title:p.name||'Oda'});
  idx.on('click',()=>{ map.flyTo(center,19); layer.openPopup(); });
  indexLayer.addLayer(idx);
}

function addIndoor(fc){
  // Level gruplarını hazırla
  fc.features.forEach(ft=>{
    const lvl = +ft.properties.level || 0;
    if (!levelGroups.has(lvl)) levelGroups.set(lvl, L.layerGroup());
  });
  // çiz ve level’lara dağıt
  const added = L.geoJSON(fc, { style:roomStyle, onEachFeature:onEachRoom });
  added.eachLayer(l=>{
    const lvl = +l.feature.properties.level || 0;
    levelGroups.get(lvl).addLayer(l);
  });
}

function addOutdoor(fc){
  L.geoJSON(fc, {
    pointToLayer: (f,latlng)=>L.marker(latlng,{title:f.properties?.name||'POI'}),
    onEachFeature: (f,layer)=>{
      const name = f.properties?.name || 'POI';
      layer.bindPopup(name);
      // arama index marker (ayrı, görünmez)
      const idx = L.marker(layer.getLatLng(),{title:name});
      idx.on('click',()=>{ map.flyTo(layer.getLatLng(),19); layer.openPopup(); });
      indexLayer.addLayer(idx);
    }
  }).addTo(outdoorGroup);
}

/* Demo verilerini merkezden üret ve ekle */
const centerLL = hotelBounds.getCenter();
const demo = demoData(centerLL);
addIndoor(demo.INDOOR);
addOutdoor(demo.OUTDOOR);

/* Layers panel */
const overlays = { "Outdoor POI": outdoorGroup, "Tesis Maskesi": maskGroup, "Otel Sınırı": hotelOutline };
[...levelGroups.entries()].forEach(([lvl,grp])=>{
  if (lvl===1) grp.addTo(map); // varsayılan açık
  overlays[`Level ${lvl}`] = grp;
});
const layersControl = L.control.layers(null, overlays, {collapsed:false, position:'topright'}).addTo(map);

/* =========================================================================
   5) SADECE OTEL İÇİ ARAMA
   ========================================================================= */
const searchCtrl = new L.Control.Search({
  layer: indexLayer,
  propertyName: 'title',
  initial: false,
  textPlaceholder: 'Otel içinde ara (SPA, Lobi, Havuz...)',
  zoom: 19,
  marker: false
});
searchCtrl.on('search:locationfound', e=>{
  if (e.layer && e.layer.getLatLng){
    map.flyTo(e.layer.getLatLng(), 19, {duration:0.5});
  }
});
map.addControl(searchCtrl);

/* =========================================================================
   6) BLUE DOT (canlı) + LOCATE butonu
   ========================================================================= */
let dot=null, acc=null, firstFix=true;
function onLocationFound(e){
  const ll=e.latlng, a=e.accuracy||0;
  if(!dot){
    dot=L.circleMarker(ll,{radius:9,weight:2,color:'#1d4ed8',fillColor:'#3b82f6',fillOpacity:0.9}).addTo(map);
    acc=L.circle(ll,{radius:a,weight:1,color:'#3b82f6',fillOpacity:.07}).addTo(map);
  } else {
    dot.setLatLng(ll);
    acc.setLatLng(ll).setRadius(a);
  }
  if(firstFix){ firstFix=false; }
}
function onLocationError(e){ console.warn(e.message); }
map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);
map.locate({ setView:false, watch:true, enableHighAccuracy:true });

L.control.locate({
  position:'topleft',
  setView: 'untilPanOrZoom',
  initialZoomLevel: 19,
  strings:{ title:"Konumumu göster" }
}).addTo(map);

/* =========================================================================
   7) DÜĞMELER: Otele Odaklan / Dışa Aktar / İçe Aktar + Çizim
   ========================================================================= */
document.getElementById('fitBtn').onclick = ()=> map.fitBounds(hotelBounds);

document.getElementById('exportBtn').onclick = ()=>{
  const indoor = [], outdoor = [];
  levelGroups.forEach(grp=>grp.eachLayer(l=>indoor.push(l.toGeoJSON())));
  outdoorGroup.eachLayer(l=>outdoor.push(l.toGeoJSON()));
  const payload = { hotel_geometry: HOTEL_GEOMETRY, indoor, outdoor };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'hotel_poi_indoor.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

document.getElementById('importBtn').onclick = ()=>{
  const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json';
  inp.onchange = (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        // temizle
        levelGroups.forEach(grp=>grp.clearLayers());
        outdoorGroup.clearLayers(); indexLayer.clearLayers();
        // otel poligonu (varsa değiştir)
        if (obj.hotel_geometry){
          if (hotelOutline){ map.removeLayer(hotelOutline); }
          hotelOutline = L.geoJSON(obj.hotel_geometry, { style:{ color:'#0078ff', weight:2, fillOpacity:0.05 } }).addTo(map);
        }
        // indoor
        if (obj.indoor){
          const fc = {type:'FeatureCollection', features: obj.indoor};
          addIndoor(fc);
        }
        // outdoor
        if (obj.outdoor){
          const fc = {type:'FeatureCollection', features: obj.outdoor};
          addOutdoor(fc);
        }
        // layer paneli tazele
        layersControl.remove();
        const newOverlays = { "Outdoor POI": outdoorGroup, "Tesis Maskesi": maskGroup, "Otel Sınırı": hotelOutline };
        levelGroups.forEach((grp, lvl)=>{ newOverlays[`Level ${lvl}`] = grp; });
        L.control.layers(null, newOverlays, {collapsed:false, position:'topright'}).addTo(map);
        map.fitBounds(hotelOutline.getBounds().pad(0.03));
        alert('İçe aktarıldı.');
      } catch(err){ alert('JSON okunamadı: '+err); }
    };
    reader.readAsText(file);
  };
  inp.click();
};

/* Geoman kontrolleri (çizim/düzenleme) */
map.pm.addControls({
  position: 'topleft',
  drawMarker: true, drawPolygon: true,
  drawRectangle: false, drawCircle: false, drawPolyline: false,
  cutPolygon: false, dragMode:false, editMode:true, removalMode:true
});
map.on('pm:create', e=>{
  // yeni geometri meta bilgisi
  const name = prompt("İsim (ör. Ana Restoran, Beach Bar, SPA, Disco)", "");
  if (name===null){ e.layer.remove(); return; }
  const type = prompt("Tür (restaurant, bar, spa, disco, pool, room, gate vb.)", "room") || "room";
  const levelStr = prompt("Kat (ör: -1, 0, 1, 2). Outdoor için boş bırak", "");
  const level = levelStr==="" ? undefined : +levelStr;

  e.layer.feature = e.layer.feature || {type:'Feature', properties:{}};
  Object.assign(e.layer.feature.properties, { id:`u-${Date.now()}`, name, type });
  if (e.layer.getLatLng){ // marker -> outdoor
    outdoorGroup.addLayer(e.layer);
    e.layer.bindPopup(name);
    const idx = L.marker(e.layer.getLatLng(),{title:name});
    idx.on('click',()=>{ map.flyTo(e.layer.getLatLng(),19); e.layer.openPopup(); });
    indexLayer.addLayer(idx);
  } else { // polygon -> indoor
    e.layer.feature.properties.level = level ?? 0;
    const lvl = level ?? 0;
    if (!levelGroups.has(lvl)) levelGroups.set(lvl, L.layerGroup());
    levelGroups.get(lvl).addLayer(e.layer);
    e.layer.setStyle(roomStyle());
    onEachRoom(e.layer.feature, e.layer); // popup + index marker
  }
});
</script>
</body>
</html>

